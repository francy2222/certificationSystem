<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impara le Coordinate Geografiche</title>
    
    <!-- Sistema Certificazione -->
    <script src="https://certificationsystem.netlify.app/certification-system.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 25px;
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.2em;
        }

        .level-info {
            text-align: center;
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #764ba2;
            font-weight: bold;
        }

        .score-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            color: white;
        }

        .score-item {
            text-align: center;
        }

        .score-item .label {
            font-size: 1em;
            opacity: 0.9;
        }

        .score-item .value {
            font-size: 2em;
            font-weight: bold;
            margin-top: 5px;
        }

        .question-container {
            text-align: center;
            padding: 20px;
            background: #f0f4ff;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 1.5em;
            color: #333;
            font-weight: bold;
        }

        .map-container {
            position: relative;
            width: 100%;
            margin: 0 auto 15px;
            border: 3px solid #667eea;
            border-radius: 10px;
            overflow: visible;
            background: #e8f4f8;
            padding: 45px 80px;
        }

        #map {
            width: 100%;
            height: 600px;
            cursor: crosshair;
        }

        .cardinal {
            position: absolute;
            font-weight: bold;
            font-size: 1.4em;
            color: #333;
            background: rgba(255,255,255,0.9);
            padding: 6px 12px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cardinal.nord { top: -40px; left: 50%; transform: translateX(-50%); }
        .cardinal.sud { bottom: -40px; left: 50%; transform: translateX(-50%); }
        .cardinal.est { right: -70px; top: 50%; transform: translateY(-50%); }
        .cardinal.ovest { left: -70px; top: 50%; transform: translateY(-50%); }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            padding: 14px 28px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .feedback {
            text-align: center;
            padding: 18px;
            margin-top: 15px;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            display: none;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .feedback.wrong {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .level-complete {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 15px;
            margin-top: 20px;
            display: none;
        }

        .level-complete h2 {
            font-size: 2em;
            margin-bottom: 15px;
        }

        .settings {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .settings label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 1.1em;
        }

        input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }

        .level-btn {
            padding: 5px 12px;
            margin: 3px;
            font-size: 1em;
            cursor: pointer;
            border: 2px solid white;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .level-btn:hover {
            background: rgba(255,255,255,0.4);
        }

        @media (max-width: 1200px) {
            #map {
                height: 500px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.6em;
            }

            .question-container {
                font-size: 1.2em;
            }

            #map {
                height: 400px;
            }

            .map-container {
                padding: 35px 50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåç Impara le Coordinate Geografiche</h1>
        <div class="level-info" id="levelInfo">Livello 0: Linee Fondamentali (Equatore, Greenwich, Poli)</div>

        <div class="score-container">
            <div class="score-item">
                <div class="label">Livello</div>
                <div class="value" id="currentLevel">0</div>
                <div style="margin-top: 8px;">
                    <button class="level-btn" onclick="changeLevel(0)">0</button>
                    <button class="level-btn" onclick="changeLevel(1)">1</button>
                    <button class="level-btn" onclick="changeLevel(2)">2</button>
                    <button class="level-btn" onclick="changeLevel(3)">3</button>
                </div>
            </div>
            <div class="score-item">
                <div class="label">Domanda</div>
                <div class="value"><span id="currentQuestion">1</span>/10</div>
            </div>
            <div class="score-item">
                <div class="label">Punteggio</div>
                <div class="value" id="score">0</div>
            </div>
        </div>

        <div class="settings">
            <label>
                <input type="checkbox" id="ttsEnabled" checked>
                Sintesi Vocale
            </label>
            <label>
                <input type="checkbox" id="soundEnabled" checked>
                Suoni
            </label>
        </div>

        <div class="question-container" id="question">
            Clicca su "Nuova Domanda" per iniziare
        </div>

        <div class="map-container">
            <canvas id="map"></canvas>
            <div class="cardinal nord">NORD</div>
            <div class="cardinal sud">SUD</div>
            <div class="cardinal est">EST</div>
            <div class="cardinal ovest">OVEST</div>
        </div>

        <div class="controls">
            <button class="btn-primary" onclick="nextQuestion()">Nuova Domanda</button>
            <button class="btn-secondary" onclick="resetGame()">Ricomincia</button>
        </div>

        <div class="feedback" id="feedback"></div>

        <div class="level-complete" id="levelComplete">
            <h2>üéâ Livello Completato!</h2>
            <p id="completionMessage"></p>
        </div>

        <!-- Pannello Certificato in fondo -->
        <div id="certificatePanel"></div>
    </div>

    <script>
        //#region Variabili Globali
        const canvas = document.getElementById('map');
        const ctx = canvas.getContext('2d');
        let currentLevel = 0;
        let currentQuestion = 0;
        let score = 0;
        let targetLat = 0;
        let targetLon = 0;
        let questionType = '';
        const questionsPerLevel = 10;
        
        // Immagine di sfondo
        let backgroundImage = null;
        let imageLoaded = false;
        
        // Traccia domande gi√† fatte per evitare ripetizioni
        let askedQuestions = [];
        let lastQuestion = null;
        
        // Domande speciali per livello 0
        const level0Questions = [
            { type: 'equator', label: 'Equatore', lat: 0 },
            { type: 'greenwich', label: 'Meridiano di Greenwich', lon: 0 },
            { type: 'north_pole', label: 'Polo Nord', lat: 90 },
            { type: 'south_pole', label: 'Polo Sud', lat: -90 }
        ];
        
        const synthesis = window.speechSynthesis;
        let italianVoice = null;

        // Carica la voce italiana
        const loadVoices = () => {
            const voices = synthesis.getVoices();
            italianVoice = voices.find(v => v.lang.includes('it-IT') && v.name.includes('Google'));
            if (!italianVoice) {
                italianVoice = voices.find(v => v.lang.includes('it'));
            }
        };

        synthesis.addEventListener('voiceschanged', loadVoices);
        loadVoices();

        // Sistema di Certificazione
        let certSystem = null;

        function initCertSystem() {
            certSystem = new CertificationSystem({
                appName: 'Coordinate Geografiche',
                appVersion: '1.2.0',
                storageKey: 'geo_coordinates_data',
                certUrl: 'https://certificationsystem.netlify.app/',
                
                fields: [
                    { key: 'livelli_completati', label: 'Livelli Completati', showZero: false },
                    { key: 'risposte_corrette', label: 'Risposte Corrette', showZero: false },
                    { key: 'risposte_sbagliate', label: 'Risposte Sbagliate', showZero: true },
                    { key: 'accuratezza', label: 'Accuratezza', type: 'percentage', showZero: true }
                ],
                
                onTimerUpdate: (seconds) => {},
                
                onFieldUpdate: () => {
                    const corrette = certSystem.getField('risposte_corrette');
                    const sbagliate = certSystem.getField('risposte_sbagliate');
                    const totali = corrette + sbagliate;
                    
                    if (totali > 0) {
                        const accuratezza = Math.round((corrette / totali) * 100);
                        certSystem.setField('accuratezza', accuratezza);
                    }
                }
            });
            
            certSystem.renderFullPanel('certificatePanel', {
                collapsible: true,
                showStudentControls: true,
                showClassroomToggle: false,
                showVerificationToggle: false
            });
        }

        // Carica immagine di sfondo
        function loadBackgroundImage() {
            backgroundImage = new Image();
            backgroundImage.onload = () => {
                imageLoaded = true;
                drawMap();
            };
            backgroundImage.onerror = () => {
                console.log('Immagine planisfero.png non trovata, uso sfondo colorato');
                imageLoaded = false;
                drawMap();
            };
            backgroundImage.src = 'planisfero.png';
        }

        // Inizializza al caricamento
        window.addEventListener('DOMContentLoaded', () => {
            initCertSystem();
            loadBackgroundImage();
        });
        //#endregion

        //#region Inizializzazione Canvas
        function resizeCanvas() {
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth;
            canvas.width = containerWidth;
            // Altezza proporzionale (rapporto 2:1 per proiezione equirettangolare)
            canvas.height = Math.min(600, containerWidth / 2);
            drawMap();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        //#endregion

        //#region Disegno Mappa
        function drawMap() {
            const w = canvas.width;
            const h = canvas.height;

            // Calcola dimensione font in base alla larghezza
            const baseFontSize = Math.max(12, Math.min(16, w / 80));
            const labelFontSize = Math.max(14, Math.min(18, w / 70));

            // Sfondo: immagine o colore
            if (imageLoaded && backgroundImage) {
                ctx.drawImage(backgroundImage, 0, 0, w, h);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
                ctx.fillRect(0, 0, w, h);
            } else {
                ctx.fillStyle = '#e8f4f8';
                ctx.fillRect(0, 0, w, h);
            }

            // Griglia (ogni 20¬∞)
            ctx.strokeStyle = imageLoaded ? 'rgba(100, 100, 100, 0.5)' : '#ccc';
            ctx.lineWidth = 1;

            // Paralleli (orizzontali) - ogni 20¬∞
            for (let lat = -80; lat <= 80; lat += 20) {
                const y = latToY(lat);
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(w, y);
                ctx.stroke();

                // Etichette
                if (Math.abs(y - 30) > 15 && Math.abs(y - (h - 30)) > 15) {
                    const text = lat + '¬∞';
                    ctx.font = `bold ${baseFontSize}px Arial`;
                    const textWidth = ctx.measureText(text).width;
                    ctx.fillStyle = 'rgba(255,255,255,0.85)';
                    ctx.fillRect(3, y - baseFontSize - 2, textWidth + 6, baseFontSize + 6);
                    ctx.fillStyle = '#333';
                    ctx.fillText(text, 6, y - 3);
                }
            }

            // Meridiani (verticali) - ogni 20¬∞
            for (let lon = -180; lon <= 180; lon += 20) {
                const x = lonToX(lon);
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, h);
                ctx.stroke();

                // Etichette
                if (lon !== 0) {
                    const text = lon + '¬∞';
                    ctx.font = `bold ${baseFontSize}px Arial`;
                    const textWidth = ctx.measureText(text).width;
                    ctx.fillStyle = 'rgba(255,255,255,0.85)';
                    ctx.fillRect(x + 2, h - baseFontSize - 8, textWidth + 6, baseFontSize + 6);
                    ctx.fillStyle = '#333';
                    ctx.fillText(text, x + 5, h - 8);
                }
            }

            // EQUATORE (rosso, pi√π spesso)
            ctx.strokeStyle = '#dc3545';
            ctx.lineWidth = 3;
            const equatorY = latToY(0);
            ctx.beginPath();
            ctx.moveTo(0, equatorY);
            ctx.lineTo(w, equatorY);
            ctx.stroke();

            // Etichetta Equatore
            ctx.font = `bold ${labelFontSize}px Arial`;
            const eqText = 'EQUATORE (0¬∞)';
            const eqTextWidth = ctx.measureText(eqText).width;
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillRect(w/2 - eqTextWidth/2 - 5, equatorY - labelFontSize - 5, eqTextWidth + 10, labelFontSize + 8);
            ctx.fillStyle = '#dc3545';
            ctx.fillText(eqText, w/2 - eqTextWidth/2, equatorY - 5);

            // MERIDIANO DI GREENWICH (rosso, pi√π spesso)
            ctx.strokeStyle = '#dc3545';
            ctx.lineWidth = 3;
            const greenwichX = lonToX(0);
            ctx.beginPath();
            ctx.moveTo(greenwichX, 0);
            ctx.lineTo(greenwichX, h);
            ctx.stroke();

            // Etichetta Greenwich
            ctx.font = `bold ${labelFontSize}px Arial`;
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillRect(greenwichX + 3, 5, 95, labelFontSize * 2 + 12);
            ctx.fillStyle = '#dc3545';
            ctx.fillText('GREENWICH', greenwichX + 8, 8 + labelFontSize);
            ctx.fillText('(0¬∞)', greenwichX + 8, 8 + labelFontSize * 2 + 4);
        }

        function latToY(lat) {
            const margin = 30;
            const usableHeight = canvas.height - (margin * 2);
            return margin + (usableHeight * (90 - lat) / 180);
        }

        function lonToX(lon) {
            return canvas.width * (lon + 180) / 360;
        }

        function yToLat(y) {
            const margin = 30;
            const usableHeight = canvas.height - (margin * 2);
            return 90 - ((y - margin) / usableHeight) * 180;
        }

        function xToLon(x) {
            return (x / canvas.width) * 360 - 180;
        }
        //#endregion

        //#region Gestione Click
        canvas.addEventListener('click', (e) => {
            if (currentQuestion === 0) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            let rawLat = yToLat(y);
            let rawLon = xToLon(x);

            const tolerance = 10;
            
            let latSnapped = false;
            let lonSnapped = false;
            
            // Controllo Polo Nord
            if (Math.abs(rawLat - 90) < tolerance) {
                rawLat = 90;
                latSnapped = true;
            }
            // Controllo Polo Sud
            else if (Math.abs(rawLat - (-90)) < tolerance) {
                rawLat = -90;
                latSnapped = true;
            }
            // Controllo Equatore
            else if (Math.abs(rawLat) < tolerance) {
                rawLat = 0;
                latSnapped = true;
            }
            
            // Controllo Greenwich
            if (Math.abs(rawLon) < tolerance) {
                rawLon = 0;
                lonSnapped = true;
            }
            // Controllo antimeridiano (180¬∞)
            else if (Math.abs(Math.abs(rawLon) - 180) < tolerance) {
                rawLon = rawLon > 0 ? 180 : -180;
                lonSnapped = true;
            }

            let clickedLat, clickedLon;
            
            if (latSnapped) {
                clickedLat = rawLat;
            } else {
                clickedLat = Math.round(rawLat / 20) * 20;
                if (clickedLat > 80) clickedLat = 80;
                if (clickedLat < -80) clickedLat = -80;
            }
            
            if (lonSnapped) {
                clickedLon = rawLon;
            } else {
                clickedLon = Math.round(rawLon / 20) * 20;
                if (clickedLon > 180) clickedLon = 180;
                if (clickedLon < -180) clickedLon = -180;
            }

            console.log('Click:', {rawLat: rawLat.toFixed(1), rawLon: rawLon.toFixed(1), clickedLat, clickedLon, latSnapped, lonSnapped});

            checkAnswer(clickedLat, clickedLon);
        });
        //#endregion

        //#region Generazione Domande
        function nextQuestion() {
            if (currentQuestion >= questionsPerLevel) {
                completeLevel();
                return;
            }

            currentQuestion++;
            document.getElementById('currentQuestion').textContent = currentQuestion;
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('levelComplete').style.display = 'none';

            drawMap();

            if (currentLevel === 0) {
                let questionData;
                let attempts = 0;
                do {
                    const index = Math.floor(Math.random() * level0Questions.length);
                    questionData = level0Questions[index];
                    attempts++;
                } while (lastQuestion === questionData.type && attempts < 10);
                
                lastQuestion = questionData.type;
                
                if (questionData.type === 'equator') {
                    targetLat = 0;
                    targetLon = null;
                    questionType = 'equator';
                    const question = `Clicca sull'EQUATORE (la linea rossa orizzontale a 0¬∞)`;
                    document.getElementById('question').textContent = question;
                    speak(question);
                } else if (questionData.type === 'greenwich') {
                    targetLat = null;
                    targetLon = 0;
                    questionType = 'greenwich';
                    const question = `Clicca sul MERIDIANO DI GREENWICH (la linea rossa verticale a 0¬∞)`;
                    document.getElementById('question').textContent = question;
                    speak(question);
                } else if (questionData.type === 'north_pole') {
                    targetLat = 90;
                    targetLon = null;
                    questionType = 'north_pole';
                    const question = `Clicca sul POLO NORD (parallelo 90¬∞ Nord, in alto)`;
                    document.getElementById('question').textContent = question;
                    speak(question);
                } else if (questionData.type === 'south_pole') {
                    targetLat = -90;
                    targetLon = null;
                    questionType = 'south_pole';
                    const question = `Clicca sul POLO SUD (parallelo 90¬∞ Sud, in basso)`;
                    document.getElementById('question').textContent = question;
                    speak(question);
                }
            } else if (currentLevel === 1) {
                let newLat;
                let attempts = 0;
                do {
                    newLat = getRandomCoordinate(-80, 80);
                    attempts++;
                } while (newLat === targetLat && attempts < 10);
                
                targetLat = newLat;
                targetLon = null;
                questionType = 'parallel';
                const question = `Clicca sul parallelo ${formatLat(targetLat)}`;
                document.getElementById('question').textContent = question;
                speak(question);
            } else if (currentLevel === 2) {
                let newLon;
                let attempts = 0;
                do {
                    newLon = getRandomCoordinate(-180, 180);
                    attempts++;
                } while (newLon === targetLon && attempts < 10);
                
                targetLat = null;
                targetLon = newLon;
                questionType = 'meridian';
                const question = `Clicca sul meridiano ${formatLon(targetLon)}`;
                document.getElementById('question').textContent = question;
                speak(question);
            } else {
                let newLat, newLon;
                let attempts = 0;
                do {
                    newLat = getRandomCoordinate(-80, 80);
                    newLon = getRandomCoordinate(-180, 180);
                    attempts++;
                } while (newLat === targetLat && newLon === targetLon && attempts < 10);
                
                targetLat = newLat;
                targetLon = newLon;
                questionType = 'point';
                const question = `Clicca sul punto ${formatLat(targetLat)}, ${formatLon(targetLon)}`;
                document.getElementById('question').textContent = question;
                speak(question);
            }
        }

        function getRandomCoordinate(min, max) {
            const step = 20;
            const range = (max - min) / step;
            return min + Math.floor(Math.random() * (range + 1)) * step;
        }

        function formatLat(lat) {
            if (lat === 0) return 'Equatore';
            return Math.abs(lat) + '¬∞ ' + (lat > 0 ? 'Nord' : 'Sud');
        }

        function formatLon(lon) {
            if (lon === 0) return 'Greenwich';
            return Math.abs(lon) + '¬∞ ' + (lon > 0 ? 'Est' : 'Ovest');
        }
        //#endregion

        //#region Verifica Risposta
        function checkAnswer(clickedLat, clickedLon) {
            let correct = false;

            if (currentLevel === 0) {
                if (questionType === 'equator') {
                    correct = clickedLat === 0;
                } else if (questionType === 'greenwich') {
                    correct = clickedLon === 0;
                } else if (questionType === 'north_pole') {
                    correct = clickedLat === 90;
                } else if (questionType === 'south_pole') {
                    correct = clickedLat === -90;
                }
            } else if (questionType === 'parallel') {
                correct = clickedLat === targetLat;
            } else if (questionType === 'meridian') {
                correct = clickedLon === targetLon;
            } else {
                correct = clickedLat === targetLat && clickedLon === targetLon;
            }

            const feedback = document.getElementById('feedback');
            feedback.style.display = 'block';

            if (correct) {
                score += 10;
                document.getElementById('score').textContent = score;
                feedback.className = 'feedback correct';
                feedback.textContent = '‚úì Corretto! Ben fatto!';
                playSound('correct');
                speak('Corretto!');

                certSystem.incrementField('risposte_corrette');

                drawCorrectPoint(targetLat, targetLon);

                setTimeout(nextQuestion, 4000);
            } else {
                feedback.className = 'feedback wrong';
                
                if (currentLevel === 0) {
                    if (questionType === 'equator') {
                        feedback.textContent = `‚úó Sbagliato! Hai cliccato su ${formatLat(clickedLat)}. L'Equatore √® a 0¬∞!`;
                    } else if (questionType === 'greenwich') {
                        feedback.textContent = `‚úó Sbagliato! Hai cliccato su ${formatLon(clickedLon)}. Greenwich √® a 0¬∞!`;
                    } else if (questionType === 'north_pole') {
                        feedback.textContent = `‚úó Sbagliato! Hai cliccato su ${formatLat(clickedLat)}. Il Polo Nord √® a 90¬∞ Nord!`;
                    } else if (questionType === 'south_pole') {
                        feedback.textContent = `‚úó Sbagliato! Hai cliccato su ${formatLat(clickedLat)}. Il Polo Sud √® a 90¬∞ Sud!`;
                    }
                } else if (questionType === 'parallel') {
                    feedback.textContent = `‚úó Sbagliato! Hai cliccato su ${formatLat(clickedLat)} invece di ${formatLat(targetLat)}`;
                } else if (questionType === 'meridian') {
                    feedback.textContent = `‚úó Sbagliato! Hai cliccato su ${formatLon(clickedLon)} invece di ${formatLon(targetLon)}`;
                } else {
                    feedback.textContent = `‚úó Sbagliato! Hai cliccato su ${formatLat(clickedLat)}, ${formatLon(clickedLon)}`;
                }
                
                playSound('wrong');
                speak('Sbagliato, riprova!');

                certSystem.incrementField('risposte_sbagliate');

                drawWrongPoint(clickedLat, clickedLon);
                setTimeout(() => drawCorrectPoint(targetLat, targetLon), 500);
            }
        }

        function drawCorrectPoint(lat, lon) {
            if (questionType === 'equator' || questionType === 'parallel' || 
                questionType === 'north_pole' || questionType === 'south_pole') {
                const y = latToY(lat);
                ctx.strokeStyle = '#28a745';
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            } else if (questionType === 'greenwich' || questionType === 'meridian') {
                const x = lonToX(lon);
                ctx.strokeStyle = '#28a745';
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            } else {
                const x = lonToX(lon);
                const y = latToY(lat);
                ctx.fillStyle = '#28a745';
                ctx.beginPath();
                ctx.arc(x, y, 12, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function drawWrongPoint(lat, lon) {
            const x = lonToX(lon);
            const y = latToY(lat);
            ctx.fillStyle = '#dc3545';
            ctx.beginPath();
            ctx.arc(x, y, 12, 0, Math.PI * 2);
            ctx.fill();
        }
        //#endregion

        //#region Gestione Livelli
        function completeLevel() {
            const levelComplete = document.getElementById('levelComplete');
            const completionMessage = document.getElementById('completionMessage');

            if (currentLevel < 3) {
                certSystem.incrementField('livelli_completati');
                
                let levelName = '';
                if (currentLevel === 0) levelName = 'Linee Fondamentali';
                else if (currentLevel === 1) levelName = 'Paralleli';
                else if (currentLevel === 2) levelName = 'Meridiani';
                
                completionMessage.textContent = `Hai completato il livello ${currentLevel}: ${levelName}! Punteggio: ${score}. Passa al livello successivo!`;
                speak(`Livello ${levelName} completato! Passa al livello successivo!`);
                playSound('level');

                setTimeout(() => {
                    currentLevel++;
                    currentQuestion = 0;
                    updateLevelInfo();
                    levelComplete.style.display = 'none';
                    nextQuestion();
                }, 3000);
            } else {
                certSystem.incrementField('livelli_completati');
                
                completionMessage.textContent = `üèÜ Hai completato tutti i livelli! Punteggio finale: ${score}`;
                speak('Congratulazioni! Hai completato tutti i livelli!');
                playSound('win');
            }

            levelComplete.style.display = 'block';
        }

        function updateLevelInfo() {
            document.getElementById('currentLevel').textContent = currentLevel;
            const levelNames = [
                'Livello 0: Linee Fondamentali (Equatore, Greenwich, Poli)',
                'Livello 1: Trova i Paralleli',
                'Livello 2: Trova i Meridiani',
                'Livello 3: Trova le Coordinate Complete'
            ];
            document.getElementById('levelInfo').textContent = levelNames[currentLevel];
        }

        function resetGame() {
            currentLevel = 0;
            currentQuestion = 0;
            score = 0;
            lastQuestion = null;
            askedQuestions = [];
            document.getElementById('score').textContent = 0;
            document.getElementById('currentQuestion').textContent = 0;
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('levelComplete').style.display = 'none';
            updateLevelInfo();
            drawMap();
        }

        function changeLevel(level) {
            if (level < 0 || level > 3) return;
            
            currentLevel = level;
            currentQuestion = 0;
            lastQuestion = null;
            askedQuestions = [];
            document.getElementById('currentQuestion').textContent = 0;
            document.getElementById('feedback').style.display = 'none';
            document.getElementById('levelComplete').style.display = 'none';
            updateLevelInfo();
            drawMap();
        }
        //#endregion

        //#region Audio
        function speak(text) {
            if (!document.getElementById('ttsEnabled').checked) return;
            
            try {
                synthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'it-IT';
                utterance.rate = 0.9;
                if (italianVoice) {
                    utterance.voice = italianVoice;
                }
                synthesis.speak(utterance);
            } catch (error) {
                console.log('TTS non disponibile:', error);
            }
        }

        function playNote(audioContext, frequency, startTime, duration, type = 'sine') {
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + startTime + duration);
                
                oscillator.start(audioContext.currentTime + startTime);
                oscillator.stop(audioContext.currentTime + startTime + duration);
            } catch (error) {
                console.log('Audio non disponibile:', error);
            }
        }

        function playSound(type) {
            if (!document.getElementById('soundEnabled').checked) return;

            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (type === 'correct') {
                    playNote(audioContext, 523.25, 0, 0.1);
                    playNote(audioContext, 659.25, 0.1, 0.1);
                    playNote(audioContext, 783.99, 0.2, 0.2);
                } else if (type === 'wrong') {
                    playNote(audioContext, 400, 0, 0.15, 'square');
                    playNote(audioContext, 300, 0.15, 0.15, 'square');
                } else if (type === 'level') {
                    playNote(audioContext, 523.25, 0, 0.1);
                    playNote(audioContext, 659.25, 0.1, 0.1);
                    playNote(audioContext, 783.99, 0.2, 0.1);
                    playNote(audioContext, 1046.50, 0.3, 0.3);
                } else if (type === 'win') {
                    playNote(audioContext, 523.25, 0, 0.15);
                    playNote(audioContext, 659.25, 0.15, 0.15);
                    playNote(audioContext, 783.99, 0.3, 0.15);
                    playNote(audioContext, 1046.50, 0.45, 0.4);
                }
            } catch (error) {
                console.log('Audio non disponibile:', error);
            }
        }
        //#endregion
    </script>
</body>
</html>
