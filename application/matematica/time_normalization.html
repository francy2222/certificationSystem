<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Normalizzazione Ore - Esercizi Matematica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        //#region Barra Controllo
        .control-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .timer-display {
            font-size: 1.3em;
            color: #667eea;
            font-weight: bold;
            padding: 8px 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #667eea;
        }

        .progress-info {
            font-size: 1.1em;
            color: #667eea;
            font-weight: bold;
        }
        //#endregion

        //#region Menu Configurazione
        .config-screen {
            display: block;
        }

        .config-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .config-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            text-align: center;
        }

        .config-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .config-option {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ddd;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .config-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .config-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .config-option-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .config-option-desc {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .slider-container {
            margin: 20px 0;
        }

        .slider-container label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .slider-value {
            text-align: center;
            font-size: 1.5em;
            color: #667eea;
            font-weight: bold;
            margin-top: 10px;
        }
        //#endregion

        //#region Schermo Esercizio
        .exercise-screen {
            display: none;
        }

        .time-display {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            text-align: center;
        }

        .time-display h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .time-values {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .time-unit {
            display: inline-flex;
            align-items: baseline;
            gap: 5px;
        }

        .time-value {
            font-size: 3em;
            font-weight: bold;
            color: #333;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 80px;
            text-align: center;
            border: 3px solid transparent;
        }

        .time-value:hover {
            background: #f0f0f0;
        }

        .time-value.selected {
            background: #ffd700;
            border-color: #ffa500;
            animation: pulse 1s infinite;
        }

        .time-value.correct {
            background: #4caf50;
            color: white;
        }

        .time-value.incorrect {
            background: #f44336;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .time-label {
            font-size: 1.5em;
            color: #666;
        }

        .normalization-work {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            display: none;
        }

        .normalization-work.show {
            display: block;
        }

        .work-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .work-label {
            font-size: 1.3em;
            color: #667eea;
            font-weight: bold;
            min-width: 100px;
        }

        .work-input {
            width: 80px;
            padding: 10px;
            font-size: 1.5em;
            text-align: center;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-weight: bold;
        }

        .work-input:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .work-operator {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .result-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .result-display.show {
            display: block;
        }
        //#endregion

        //#region Calcolatrice
        .calculator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
            width: 350px;
        }

        .calculator.show {
            display: block;
        }

        .calc-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .calc-overlay.show {
            display: block;
        }

        .calc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calc-header h3 {
            color: #667eea;
            margin: 0;
        }

        .calc-close {
            background: #f44336;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
        }

        .calc-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: right;
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            min-height: 50px;
        }

        .calc-quick-ops {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .calc-btn {
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8f9fa;
            color: #333;
        }

        .calc-btn:hover {
            background: #e0e0e0;
            transform: scale(1.05);
        }

        .calc-btn.operator {
            background: #667eea;
            color: white;
        }

        .calc-btn.equals {
            background: #4caf50;
            color: white;
            grid-column: span 2;
        }

        .calc-btn.quick {
            background: #ff9800;
            color: white;
        }
        //#endregion

        //#region Bottoni
        .btn {
            padding: 12px 30px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            color: #333;
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        //#endregion

        //#region Responsive
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .time-value {
                font-size: 2em;
                min-width: 60px;
            }

            .calculator {
                width: 90%;
                max-width: 350px;
            }

            .control-bar {
                flex-direction: column;
            }
        }
        //#endregion

        //#region Pannello Certificato
        .certificate-panel {
            margin-top: 30px;
        }
        //#endregion
    </style>
</head>
<body>
    <div class="container">
        <h1>⏰ Normalizzazione delle Ore</h1>
        <p class="subtitle">Impara a normalizzare valori di tempo</p>

        <!-- Barra di controllo -->
        <div class="control-bar">
            <div class="timer-display" id="timerDisplay">⏱️ 00:00</div>
            <div class="progress-info" id="progressInfo">0/0 completati</div>
            <button class="btn btn-info" onclick="toggleCalculator()">🧮 Calcolatrice</button>
        </div>

        <!-- ==================== SCHERMATA CONFIGURAZIONE ==================== -->
        <div class="config-screen" id="configScreen">
            <!-- Selezione Livello -->
            <div class="config-section">
                <h3>📊 Seleziona il Livello</h3>
                <div class="config-options">
                    <div class="config-option" onclick="selectLevel('base')" data-level="base">
                        <div class="config-option-title">🟢 Base</div>
                        <div class="config-option-desc">3 campi: ore, minuti, secondi</div>
                    </div>
                    <div class="config-option" onclick="selectLevel('avanzato')" data-level="avanzato">
                        <div class="config-option-title">🔴 Avanzato</div>
                        <div class="config-option-desc">4 campi: giorni, ore, minuti, secondi</div>
                    </div>
                </div>
            </div>

            <!-- Selezione Difficoltà -->
            <div class="config-section">
                <h3>🎯 Seleziona la Difficoltà</h3>
                <div class="config-options">
                    <div class="config-option" onclick="selectDifficulty('facile')" data-difficulty="facile">
                        <div class="config-option-title">😊 Facile</div>
                        <div class="config-option-desc">1 valore non normalizzato</div>
                    </div>
                    <div class="config-option" onclick="selectDifficulty('medio')" data-difficulty="medio">
                        <div class="config-option-title">😐 Medio</div>
                        <div class="config-option-desc">2 valori non normalizzati</div>
                    </div>
                    <div class="config-option" onclick="selectDifficulty('difficile')" data-difficulty="difficile">
                        <div class="config-option-title">😤 Difficile</div>
                        <div class="config-option-desc">3+ valori non normalizzati</div>
                    </div>
                </div>
            </div>

            <!-- Numero Esercizi -->
            <div class="config-section">
                <h3>🔢 Numero di Esercizi</h3>
                <div class="slider-container">
                    <input type="range" id="exerciseCount" min="1" max="50" value="10" 
                           oninput="updateSliderValue(this.value)">
                    <div class="slider-value" id="sliderValue">10 esercizi</div>
                </div>
            </div>

            <div class="btn-actions">
                <button class="btn btn-success" onclick="startExercises()">🚀 Inizia Esercizi</button>
            </div>
        </div>

        <!-- ==================== SCHERMATA ESERCIZIO ==================== -->
        <div class="exercise-screen" id="exerciseScreen">
            <!-- Display Tempo -->
            <div class="time-display">
                <h3 id="instructionText">Clicca sui valori NON normalizzati</h3>
                <div class="time-values" id="timeValues"></div>
            </div>

            <!-- Area di Lavoro Normalizzazione -->
            <div class="normalization-work" id="normalizationWork">
                <div class="work-row">
                    <span class="work-label">Valore selezionato:</span>
                    <span class="work-operator" id="selectedValue">-</span>
                </div>
                
                <div class="work-row">
                    <input type="number" class="work-input" id="input1" placeholder="+">
                    <input type="number" class="work-input" id="input2" placeholder="-">
                    <input type="number" class="work-input" id="input3" placeholder="=">
                </div>

                <div class="result-display" id="resultDisplay">
                    <div class="work-row">
                        <span class="work-label">Risultato:</span>
                        <div class="time-values" id="normalizedResult"></div>
                    </div>
                </div>
            </div>

            <!-- Bottoni Azione -->
            <div class="btn-actions">
                <button class="btn btn-success" onclick="checkAnswer()">✅ Verifica</button>
                <button class="btn btn-warning" onclick="skipExercise()">⏭️ Salta</button>
                <button class="btn btn-info" onclick="showHelp()">💡 Aiuto</button>
            </div>
        </div>

        <!-- Pannello Certificato -->
        <div class="certificate-panel" id="certificateContainer"></div>
    </div>

    <!-- Calcolatrice Overlay -->
    <div class="calc-overlay" id="calcOverlay" onclick="toggleCalculator()"></div>
    
    <!-- Calcolatrice -->
    <div class="calculator" id="calculator">
        <div class="calc-header">
            <h3>🧮 Calcolatrice</h3>
            <button class="calc-close" onclick="toggleCalculator()">×</button>
        </div>
        
        <div class="calc-display" id="calcDisplay">0</div>
        
        <div class="calc-quick-ops">
            <button class="calc-btn quick" onclick="quickCalc('-60')">-60</button>
            <button class="calc-btn quick" onclick="quickCalc('-24')">-24</button>
        </div>
        
        <div class="calc-buttons">
            <button class="calc-btn" onclick="calcInput('7')">7</button>
            <button class="calc-btn" onclick="calcInput('8')">8</button>
            <button class="calc-btn" onclick="calcInput('9')">9</button>
            <button class="calc-btn operator" onclick="calcInput('÷')">÷</button>
            
            <button class="calc-btn" onclick="calcInput('4')">4</button>
            <button class="calc-btn" onclick="calcInput('5')">5</button>
            <button class="calc-btn" onclick="calcInput('6')">6</button>
            <button class="calc-btn operator" onclick="calcInput('×')">×</button>
            
            <button class="calc-btn" onclick="calcInput('1')">1</button>
            <button class="calc-btn" onclick="calcInput('2')">2</button>
            <button class="calc-btn" onclick="calcInput('3')">3</button>
            <button class="calc-btn operator" onclick="calcInput('-')">-</button>
            
            <button class="calc-btn" onclick="calcInput('0')">0</button>
            <button class="calc-btn" onclick="calcClear()">C</button>
            <button class="calc-btn equals" onclick="calcEquals()">=</button>
            <button class="calc-btn operator" onclick="calcInput('+')">+</button>
        </div>
    </div>

    <!-- Sistema Certificazione -->
    <script src="https://certificationsystem.netlify.app/certification-system.js"></script>

    <script>
        //#region Variabili Globali
        let certSystem = null;
        let config = {
            level: null,
            difficulty: null,
            exerciseCount: 10
        };
        let currentExercise = 0;
        let totalExercises = 0;
        let exerciseData = null;
        let selectedUnit = null;
        let phase = 1; // 1 = selezione, 2 = normalizzazione
        
        // Statistiche
        let stats = {
            correct: 0,
            errors: 0,
            skipped: 0,
            hints: 0
        };

        // Audio
        const sounds = {
            correct: 'https://certificationsystem.netlify.app/application/sounds/level-complete-394515.mp3',
            wrong: 'https://certificationsystem.netlify.app/application/sounds/wrong-47985.mp3',
            click: 'https://certificationsystem.netlify.app/application/sounds/click2.mp3'
        };
        //#endregion

        //#region Inizializzazione Sistema Certificazione
        window.addEventListener('DOMContentLoaded', () => {
            certSystem = new CertificationSystem({
                appName: 'Normalizzazione Ore',
                appVersion: '1.0.0',
                storageKey: 'normalizzazione_ore_v1',
                certUrl: 'https://certificationsystem.netlify.app/',
                trackFocus: false,
                
                fields: [
                    { key: 'completed', label: 'Esercizi Completati', showZero: false },
                    { key: 'correct', label: 'Risposte Corrette', showZero: false },
                    { key: 'errors', label: 'Errori', showZero: true },
                    { key: 'skipped', label: 'Esercizi Saltati', showZero: true },
                    { key: 'hints', label: 'Aiuti Usati', showZero: true }
                ],
                
                onTimerUpdate: (time) => {
                    const minutes = Math.floor(time / 60);
                    const seconds = time % 60;
                    document.getElementById('timerDisplay').textContent = 
                        `⏱️ ${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
                },
                
                onFieldUpdate: () => {
                    certSystem.renderStatsPanel('certificateContainer-stats');
                },
                
                onReset: () => {
                    stats = { correct: 0, errors: 0, skipped: 0, hints: 0 };
                }
            });

            certSystem.renderFullPanel('certificateContainer', {
                collapsible: true,
                showStudentControls: true,
                showClassroomToggle: false
            });
        });
        //#endregion

        //#region Funzioni Configurazione
        function selectLevel(level) {
            config.level = level;
            playSound('click');
            
            // Update UI
            document.querySelectorAll('[data-level]').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-level="${level}"]`).classList.add('selected');
        }

        function selectDifficulty(difficulty) {
            config.difficulty = difficulty;
            playSound('click');
            
            // Update UI
            document.querySelectorAll('[data-difficulty]').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-difficulty="${difficulty}"]`).classList.add('selected');
        }

        function updateSliderValue(value) {
            config.exerciseCount = parseInt(value);
            document.getElementById('sliderValue').textContent = `${value} esercizi`;
        }

        function startExercises() {
            // Validazione
            if (!config.level) {
                alert('❌ Seleziona un livello!');
                return;
            }
            if (!config.difficulty) {
                alert('❌ Seleziona una difficoltà!');
                return;
            }

            // Inizializza
            currentExercise = 0;
            totalExercises = config.exerciseCount;
            stats = { correct: 0, errors: 0, skipped: 0, hints: 0 };

            // Cambia schermata
            document.getElementById('configScreen').style.display = 'none';
            document.getElementById('exerciseScreen').style.display = 'block';

            // Genera primo esercizio
            generateExercise();
        }
        //#endregion

        //#region Generazione Esercizi
        function generateExercise() {
            currentExercise++;
            phase = 1;
            selectedUnit = null;

            // Update progress
            document.getElementById('progressInfo').textContent = 
                `${currentExercise}/${totalExercises} completati`;

            // Nascondi area lavoro
            document.getElementById('normalizationWork').classList.remove('show');
            document.getElementById('resultDisplay').classList.remove('show');

            // Reset inputs
            document.getElementById('input1').value = '';
            document.getElementById('input2').value = '';
            document.getElementById('input3').value = '';

            // Genera valori
            const numFields = config.level === 'base' ? 3 : 4;
            let numNonNormalized;
            
            switch(config.difficulty) {
                case 'facile': numNonNormalized = 1; break;
                case 'medio': numNonNormalized = 2; break;
                case 'difficile': numNonNormalized = Math.min(numFields, 3); break;
            }

            exerciseData = generateTimeValues(numFields, numNonNormalized);
            
            // Mostra valori
            displayTimeValues(exerciseData.values);
            
            // Aggiorna istruzioni
            document.getElementById('instructionText').textContent = 
                'Clicca sui valori NON normalizzati';
        }

        function generateTimeValues(numFields, numNonNormalized) {
            const labels = config.level === 'base' 
                ? ['h', 'm', 's'] 
                : ['g', 'h', 'm', 's'];
            
            const limits = config.level === 'base'
                ? [null, 60, 60]
                : [null, 24, 60, 60];

            let values = [];
            let nonNormalizedIndices = [];

            // Seleziona quali campi saranno non normalizzati
            while (nonNormalizedIndices.length < numNonNormalized) {
                let idx = Math.floor(Math.random() * numFields);
                if (!nonNormalizedIndices.includes(idx) && limits[idx] !== null) {
                    nonNormalizedIndices.push(idx);
                }
            }

            // Genera valori
            for (let i = 0; i < numFields; i++) {
                if (nonNormalizedIndices.includes(i)) {
                    // Valore non normalizzato
                    const limit = limits[i];
                    values.push(limit + Math.floor(Math.random() * 50) + 10);
                } else {
                    // Valore normale
                    const limit = limits[i];
                    if (limit === null) {
                        values.push(Math.floor(Math.random() * 5));
                    } else {
                        values.push(Math.floor(Math.random() * (limit - 10)));
                    }
                }
            }

            return {
                values: values,
                labels: labels,
                limits: limits,
                nonNormalizedIndices: nonNormalizedIndices
            };
        }

        function displayTimeValues(values) {
            const container = document.getElementById('timeValues');
            container.innerHTML = '';

            values.forEach((value, index) => {
                const unit = document.createElement('div');
                unit.className = 'time-unit';
                
                const valueSpan = document.createElement('span');
                valueSpan.className = 'time-value';
                valueSpan.textContent = value;
                valueSpan.dataset.index = index;
                valueSpan.onclick = () => selectValue(index);
                
                const labelSpan = document.createElement('span');
                labelSpan.className = 'time-label';
                labelSpan.textContent = exerciseData.labels[index];
                
                unit.appendChild(valueSpan);
                unit.appendChild(labelSpan);
                container.appendChild(unit);
            });
        }
        //#endregion

        //#region Interazione Esercizio
        function selectValue(index) {
            playSound('click');

            if (phase === 1) {
                // Fase 1: selezione valore non normalizzato
                
                // Deseleziona precedente
                document.querySelectorAll('.time-value').forEach(el => {
                    el.classList.remove('selected');
                });

                // Seleziona nuovo
                const valueElement = document.querySelector(`[data-index="${index}"]`);
                valueElement.classList.add('selected');
                selectedUnit = index;

                // Se è davvero non normalizzato, passa alla fase 2
                if (exerciseData.nonNormalizedIndices.includes(index)) {
                    phase = 2;
                    showNormalizationWork(index);
                }
            }
        }

        function showNormalizationWork(index) {
            const workArea = document.getElementById('normalizationWork');
            workArea.classList.add('show');

            // Mostra valore selezionato
            document.getElementById('selectedValue').textContent = 
                `${exerciseData.values[index]}${exerciseData.labels[index]}`;

            // Aggiorna istruzioni
            document.getElementById('instructionText').textContent = 
                'Completa la normalizzazione';

            // Pre-compila operazioni corrette
            const limit = exerciseData.limits[index];
            document.getElementById('input1').placeholder = '+1';
            document.getElementById('input2').placeholder = `-${limit}`;
        }

        function checkAnswer() {
            if (phase === 1) {
                // Verifica selezione valori non normalizzati
                if (selectedUnit === null) {
                    alert('❌ Seleziona un valore prima!');
                    return;
                }

                if (exerciseData.nonNormalizedIndices.includes(selectedUnit)) {
                    // Corretto! Passa alla fase 2
                    playSound('correct');
                    phase = 2;
                    showNormalizationWork(selectedUnit);
                } else {
                    // Sbagliato
                    playSound('wrong');
                    stats.errors++;
                    certSystem.incrementField('errors');
                    
                    const valueElement = document.querySelector(`[data-index="${selectedUnit}"]`);
                    valueElement.classList.add('incorrect');
                    
                    setTimeout(() => {
                        valueElement.classList.remove('incorrect');
                        selectedUnit = null;
                    }, 1000);
                }
            } else if (phase === 2) {
                // Verifica normalizzazione
                const input1 = parseInt(document.getElementById('input1').value) || 0;
                const input2 = parseInt(document.getElementById('input2').value) || 0;
                const input3 = parseInt(document.getElementById('input3').value) || 0;

                // Calcola risposta corretta
                const currentValue = exerciseData.values[selectedUnit];
                const limit = exerciseData.limits[selectedUnit];
                const expectedAdd = 1;
                const expectedSub = limit;
                const expectedResult = currentValue - limit;

                if (input1 === expectedAdd && input2 === expectedSub && input3 === expectedResult) {
                    // CORRETTO!
                    playSound('correct');
                    stats.correct++;
                    certSystem.incrementField('correct');
                    certSystem.incrementField('completed');

                    // Mostra risultato normalizzato
                    showNormalizedResult();

                    // Passa al prossimo esercizio dopo 2 secondi
                    setTimeout(() => {
                        if (currentExercise < totalExercises) {
                            generateExercise();
                        } else {
                            showFinalReport();
                        }
                    }, 2000);
                } else {
                    // SBAGLIATO
                    playSound('wrong');
                    stats.errors++;
                    certSystem.incrementField('errors');
                    alert('❌ Risposta errata! Riprova.');
                }
            }
        }

        function showNormalizedResult() {
            const resultDisplay = document.getElementById('resultDisplay');
            resultDisplay.classList.add('show');

            // Calcola valori normalizzati completi
            let normalized = [...exerciseData.values];
            const idx = selectedUnit;
            const limit = exerciseData.limits[idx];
            
            normalized[idx] = normalized[idx] - limit;
            if (idx > 0) {
                normalized[idx - 1] = normalized[idx - 1] + 1;
            }

            // Mostra risultato
            const container = document.getElementById('normalizedResult');
            container.innerHTML = '';

            normalized.forEach((value, index) => {
                const unit = document.createElement('div');
                unit.className = 'time-unit';
                
                const valueSpan = document.createElement('span');
                valueSpan.className = 'time-value correct';
                valueSpan.textContent = value;
                
                const labelSpan = document.createElement('span');
                labelSpan.className = 'time-label';
                labelSpan.textContent = exerciseData.labels[index];
                
                unit.appendChild(valueSpan);
                unit.appendChild(labelSpan);
                container.appendChild(unit);
            });
        }

        function skipExercise() {
            if (!confirm('⏭️ Vuoi davvero saltare questo esercizio?')) return;
            
            playSound('click');
            stats.skipped++;
            certSystem.incrementField('skipped');

            if (currentExercise < totalExercises) {
                generateExercise();
            } else {
                showFinalReport();
            }
        }

        function showHelp() {
            playSound('click');
            stats.hints++;
            certSystem.incrementField('hints');

            let helpText = '';
            
            if (phase === 1) {
                helpText = `💡 AIUTO - Fase 1\n\n`;
                helpText += `Cerca i valori che superano il limite:\n`;
                if (config.level === 'avanzato') {
                    helpText += `• Ore >= 24\n`;
                }
                helpText += `• Minuti >= 60\n`;
                helpText += `• Secondi >= 60\n\n`;
                helpText += `Questi valori sono NON normalizzati!`;
            } else {
                const limit = exerciseData.limits[selectedUnit];
                const value = exerciseData.values[selectedUnit];
                const unit = exerciseData.labels[selectedUnit];
                
                helpText = `💡 AIUTO - Fase 2\n\n`;
                helpText += `Per normalizzare ${value}${unit}:\n\n`;
                helpText += `1. Aggiungi +1 all'unità precedente\n`;
                helpText += `2. Sottrai -${limit} dal valore corrente\n`;
                helpText += `3. Il risultato sarà ${value - limit}${unit}`;
            }

            alert(helpText);
        }

        function showFinalReport() {
            const accuracy = totalExercises > 0 
                ? Math.round((stats.correct / totalExercises) * 100) 
                : 0;

            let message = `🎉 ESERCIZI COMPLETATI!\n\n`;
            message += `✅ Corrette: ${stats.correct}\n`;
            message += `❌ Errori: ${stats.errors}\n`;
            message += `⏭️ Saltati: ${stats.skipped}\n`;
            message += `💡 Aiuti: ${stats.hints}\n`;
            message += `📊 Precisione: ${accuracy}%\n\n`;

            if (accuracy >= 90) {
                message += `⭐⭐⭐ ECCELLENTE!`;
            } else if (accuracy >= 70) {
                message += `⭐⭐ MOLTO BENE!`;
            } else if (accuracy >= 50) {
                message += `⭐ BUON LAVORO!`;
            } else {
                message += `💪 Continua ad esercitarti!`;
            }

            alert(message);

            // Torna al menu
            document.getElementById('exerciseScreen').style.display = 'none';
            document.getElementById('configScreen').style.display = 'block';
        }
        //#endregion

        //#region Calcolatrice
        let calcDisplay = '0';
        let calcMemory = 0;
        let calcOperator = '';
        let calcNewNumber = true;

        function toggleCalculator() {
            const calc = document.getElementById('calculator');
            const overlay = document.getElementById('calcOverlay');
            const isVisible = calc.classList.contains('show');
            
            if (isVisible) {
                calc.classList.remove('show');
                overlay.classList.remove('show');
            } else {
                calc.classList.add('show');
                overlay.classList.add('show');
            }
            
            playSound('click');
        }

        function calcInput(value) {
            playSound('click');
            
            if (calcNewNumber) {
                calcDisplay = value;
                calcNewNumber = false;
            } else {
                if (['+', '-', '×', '÷'].includes(value)) {
                    if (calcOperator) calcEquals();
                    calcMemory = parseFloat(calcDisplay);
                    calcOperator = value;
                    calcNewNumber = true;
                } else {
                    calcDisplay += value;
                }
            }
            
            document.getElementById('calcDisplay').textContent = calcDisplay;
        }

        function calcEquals() {
            if (!calcOperator) return;
            
            const current = parseFloat(calcDisplay);
            let result = 0;
            
            switch(calcOperator) {
                case '+': result = calcMemory + current; break;
                case '-': result = calcMemory - current; break;
                case '×': result = calcMemory * current; break;
                case '÷': result = calcMemory / current; break;
            }
            
            calcDisplay = result.toString();
            document.getElementById('calcDisplay').textContent = calcDisplay;
            calcOperator = '';
            calcNewNumber = true;
        }

        function calcClear() {
            playSound('click');
            calcDisplay = '0';
            calcMemory = 0;
            calcOperator = '';
            calcNewNumber = true;
            document.getElementById('calcDisplay').textContent = calcDisplay;
        }

        function quickCalc(operation) {
            playSound('click');
            const current = parseFloat(calcDisplay);
            const value = parseInt(operation);
            const result = current + value;
            calcDisplay = result.toString();
            document.getElementById('calcDisplay').textContent = calcDisplay;
            calcNewNumber = true;
        }
        //#endregion

        //#region Utility
        function playSound(type) {
            if (sounds[type]) {
                const audio = new Audio(sounds[type]);
                audio.volume = 0.3;
                audio.play().catch(e => console.log('Audio play failed:', e));
            }
        }
        //#endregion
    </script>
</body>
</html>
