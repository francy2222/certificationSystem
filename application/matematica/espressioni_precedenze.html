<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impara le Espressioni - Livello 1</title>
    <style>
        //#region Stili Base
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }

        h1 {
            color: #764ba2;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2em;
        }
        //#endregion

        //#region Selettore Livelli
        .level-selector {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .level-btn {
            padding: 15px 25px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
            font-weight: bold;
            color: #666;
            min-width: 140px;
        }

        .level-btn small {
            display: block;
            font-weight: normal;
            font-size: 0.8em;
            margin-top: 5px;
            color: #999;
        }

        .level-btn:hover:not(.disabled) {
            border-color: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.2);
        }

        .level-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #764ba2;
        }

        .level-btn.active small {
            color: rgba(255, 255, 255, 0.9);
        }

        .level-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        //#endregion

        //#region Area Espressione
        .expression-area {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .expression {
            font-size: 3em;
            font-family: 'Courier New', monospace;
            letter-spacing: 8px;
            user-select: none;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }

        .token {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            background: white;
            border: 2px solid transparent;
        }

        .token.parenthesis {
            font-size: 1.2em;
            font-weight: bold;
            padding: 5px 6px;
            cursor: default;
            background: transparent;
        }

        .token.parenthesis.round {
            color: #764ba2;
        }

        .token.parenthesis.square {
            color: #e74c3c;
            font-size: 1.3em;
        }

        .token.parenthesis.open {
            margin-right: -5px;
        }

        .token.parenthesis.close {
            margin-left: -5px;
        }

        .token:hover:not(.parenthesis):not(.selected) {
            background: rgba(118, 75, 162, 0.1);
            transform: scale(1.05);
        }

        .token.selected {
            background: #ffd93d !important;
            border-color: #ffcc00;
            box-shadow: 0 4px 15px rgba(255, 217, 61, 0.5);
            animation: pulse 1s infinite;
            z-index: 10;
        }

        .token.correct {
            background: #6bcf7c !important;
            border-color: #5ab969;
            animation: correctFlash 0.6s ease;
        }

        .token.incorrect {
            background: #ff6b6b !important;
            border-color: #ff5252;
            animation: shake 0.5s ease;
        }

        .token.inside-parentheses:not(.parenthesis) {
            background: rgba(118, 75, 162, 0.08);
            border-color: rgba(118, 75, 162, 0.2);
        }

        .token.inside-square-brackets:not(.parenthesis) {
            background: rgba(231, 76, 60, 0.08);
            border-color: rgba(231, 76, 60, 0.2);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes correctFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        //#endregion

        //#region Controlli e Pulsanti
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        button {
            padding: 15px 30px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-verify {
            background: #6bcf7c;
            color: white;
        }

        .btn-verify:hover {
            background: #5ab969;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(107, 207, 124, 0.4);
        }

        .btn-reset {
            background: #ff6b6b;
            color: white;
        }

        .btn-reset:hover {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-next {
            background: #4a90e2;
            color: white;
        }

        .btn-next:hover {
            background: #357abd;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        //#endregion

        //#region Feedback e Istruzioni
        .feedback {
            text-align: center;
            font-size: 1.3em;
            margin-bottom: 20px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .feedback.success {
            color: #6bcf7c;
            font-weight: bold;
        }

        .feedback.error {
            color: #ff6b6b;
            font-weight: bold;
        }

        .feedback.hint {
            color: #4a90e2;
            font-style: italic;
        }

        .instructions {
            background: #e7f3ff;
            border-left: 4px solid #4a90e2;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .instructions h3 {
            color: #4a90e2;
            margin-bottom: 10px;
        }

        .instructions p {
            color: #555;
            line-height: 1.6;
        }
        //#endregion

        //#region Stats e Progress
        .stats {
            display: flex;
            justify-content: space-around;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #764ba2;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            border-radius: 5px;
        }
        //#endregion
    </style>
</head>
<body>
    <div class="container">
        <h1>üßÆ Impara le Precedenze</h1>
        <div class="subtitle">Allena la tua mente con l'ordine delle operazioni!</div>
        
        <div class="level-selector">
            <button class="level-btn active" onclick="selectLevel(1)">Livello 1<br><small>Solo operazioni</small></button>
            <button class="level-btn" onclick="selectLevel(2)">Livello 2<br><small>Parentesi tonde</small></button>
            <button class="level-btn" onclick="selectLevel(3)">Livello 3<br><small>Tonde e quadre</small></button>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
        </div>

        <div class="instructions">
            <h3>üìù Come giocare:</h3>
            <p id="levelInstructions">
                1Ô∏è‚É£ Evidenzia le operazioni da svolgere per prime (moltiplicazioni e divisioni)<br>
                2Ô∏è‚É£ Puoi selezionare pi√π operazioni cliccando sui numeri e operatori<br>
                3Ô∏è‚É£ Quando hai finito, clicca su "Verifica" per controllare<br>
                üí° Ricorda: prima √ó e √∑, poi + e ‚àí
            </p>
        </div>

        <div class="expression-area">
            <div class="expression" id="expression"></div>
        </div>

        <div class="feedback" id="feedback">Seleziona le operazioni da svolgere per prime</div>

        <div class="controls">
            <button class="btn-reset" onclick="resetSelection()">üîÑ Ripulisci</button>
            <button class="btn-verify" onclick="verifySelection()">‚úì Verifica</button>
            <button class="btn-next" onclick="nextExercise()" style="display: none;">‚ûú Prossimo</button>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="correct">0</div>
                <div class="stat-label">Corretti</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="attempts">0</div>
                <div class="stat-label">Tentativi</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="streak">0</div>
                <div class="stat-label">Serie</div>
            </div>
        </div>

        <!-- Pannello Certificato -->
        <div id="certificatePanel"></div>
    </div>

    <!-- Sistema Certificazione -->
    <script src="https://certificationsystem.netlify.app/certification-system.js"></script>

    <script>
        //#region Variabili Globali
        let currentExpression = [];
        let selectedTokens = new Set();
        let correctGroups = [];
        let currentLevel = 1;
        let stats = {
            correct: 0,
            attempts: 0,
            streak: 0
        };
        let exerciseCount = 0;
        let certSystem = null;
        //#endregion

        //#region Sistema Certificazione
        function initCertSystem() {
            certSystem = new CertificationSystem({
                appName: 'Impara le Precedenze',
                appVersion: '1.0.0',
                storageKey: 'precedenze_math',
                certUrl: 'https://certificationsystem.netlify.app/',
                trackFocus: true,
                fields: [
                    { key: 'ex_l1', label: 'Esercizi Livello 1', showZero: false },
                    { key: 'ex_l2', label: 'Esercizi Livello 2', showZero: false },
                    { key: 'ex_l3', label: 'Esercizi Livello 3', showZero: false },
                    { key: 'correct', label: 'Risposte Corrette', showZero: false },
                    { key: 'errors', label: 'Errori', showZero: true },
                    { key: 'streak_max', label: 'Serie Massima', showZero: false }
                ],
                onTimerUpdate: (seconds) => {
                    // Timer gestito dal sistema
                },
                onFieldUpdate: (key, value) => {
                    // Aggiorna UI se necessario
                },
                onReset: () => {
                    // Reset statistiche locali
                    stats = { correct: 0, attempts: 0, streak: 0 };
                    exerciseCount = 0;
                    updateStats();
                }
            });
        }

        function updateCertStats() {
            if (!certSystem) return;
            
            // Aggiorna il campo del livello corrente
            const levelKey = 'ex_l' + currentLevel;
            certSystem.incrementField(levelKey);
        }

        function recordCorrectAnswer() {
            if (!certSystem) return;
            certSystem.incrementField('correct');
            
            // Aggiorna serie massima se necessario
            const currentMax = certSystem.getField('streak_max') || 0;
            if (stats.streak > currentMax) {
                certSystem.setField('streak_max', stats.streak);
            }
        }

        function recordError() {
            if (!certSystem) return;
            certSystem.incrementField('errors');
        }
        //#endregion

        //#region Gestione Livelli
        function selectLevel(level) {
            currentLevel = level;
            
            // Aggiorna UI
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.level-btn')[level - 1].classList.add('active');
            
            // Aggiorna istruzioni
            updateInstructions();
            
            // Reset statistiche per il nuovo livello
            stats = { correct: 0, attempts: 0, streak: 0 };
            exerciseCount = 0;
            updateStats();
            
            // Genera nuovo esercizio
            initExercise();
        }

        function updateInstructions() {
            const instructions = document.getElementById('levelInstructions');
            
            if (currentLevel === 1) {
                instructions.innerHTML = `
                    1Ô∏è‚É£ Evidenzia <strong>TUTTE</strong> le operazioni da svolgere per prime (moltiplicazioni e divisioni)<br>
                    2Ô∏è‚É£ Puoi selezionare pi√π operazioni cliccando sui numeri e operatori<br>
                    3Ô∏è‚É£ Quando hai finito, clicca su "Verifica" per controllare<br>
                    üí° Ricorda: prima √ó e √∑, poi + e ‚àí
                `;
            } else if (currentLevel === 2) {
                instructions.innerHTML = `
                    1Ô∏è‚É£ Evidenzia <strong>TUTTE</strong> le operazioni da svolgere per prime DENTRO le parentesi tonde ()<br>
                    2Ô∏è‚É£ Se ci sono √ó o √∑, evidenzia <strong>tutte</strong> quelle<br>
                    3Ô∏è‚É£ Se ci sono solo + e ‚àí, evidenzia tutte le operazioni nelle parentesi<br>
                    üí° Ricorda: prima risolvi le parentesi!
                `;
            } else if (currentLevel === 3) {
                instructions.innerHTML = `
                    1Ô∏è‚É£ Se ci sono parentesi tonde () ‚Üí seleziona le operazioni DENTRO le tonde<br>
                    2Ô∏è‚É£ Se ci sono SOLO quadre [] ‚Üí seleziona le operazioni DENTRO le quadre<br>
                    3Ô∏è‚É£ Se ci sono √ó o √∑, seleziona <strong>tutte</strong> quelle. Altrimenti seleziona tutte le operazioni<br>
                    üí° Le tonde hanno sempre la priorit√†, anche se sono dentro le quadre!
                `;
            }
        }
        //#endregion

        //#region Generazione Espressioni
        function generateExpressionLevel1() {
            const operations = ['+', '-', '√ó', '√∑'];
            const length = Math.floor(Math.random() * 3) + 4; // 4-6 operazioni
            let expr = [];
            
            expr.push(Math.floor(Math.random() * 20) + 1);
            
            for (let i = 0; i < length; i++) {
                const op = operations[Math.floor(Math.random() * operations.length)];
                expr.push(op);
                expr.push(Math.floor(Math.random() * 15) + 1);
            }
            
            return expr;
        }

        function generateExpressionLevel2() {
            const operations = ['+', '-', '√ó', '√∑'];
            let expr = [];
            
            // Parte iniziale (prima delle parentesi)
            expr.push(Math.floor(Math.random() * 20) + 1);
            expr.push(operations[Math.floor(Math.random() * operations.length)]);
            
            // Parentesi aperta
            expr.push('(');
            
            // Contenuto delle parentesi (2-3 operazioni)
            const insideLength = Math.floor(Math.random() * 2) + 2;
            expr.push(Math.floor(Math.random() * 15) + 1);
            
            // Garantiamo almeno una √ó o √∑ ma non tutte
            let hasPriority = false;
            let hasNonPriority = false;
            
            for (let i = 0; i < insideLength; i++) {
                let op;
                
                // Se siamo all'ultima operazione e non abbiamo mix, forziamo
                if (i === insideLength - 1) {
                    if (!hasPriority && Math.random() < 0.7) {
                        // 70% di probabilit√† di avere almeno una √ó o √∑
                        op = ['√ó', '√∑'][Math.floor(Math.random() * 2)];
                    } else if (!hasNonPriority && hasPriority) {
                        // Se abbiamo solo prioritarie, aggiungi una non prioritaria
                        op = ['+', '-'][Math.floor(Math.random() * 2)];
                    } else {
                        op = operations[Math.floor(Math.random() * operations.length)];
                    }
                } else {
                    // Per le altre operazioni, 40% √ó o √∑, 60% + o -
                    op = Math.random() < 0.4 ? 
                        ['√ó', '√∑'][Math.floor(Math.random() * 2)] : 
                        ['+', '-'][Math.floor(Math.random() * 2)];
                }
                
                if (op === '√ó' || op === '√∑') hasPriority = true;
                if (op === '+' || op === '-') hasNonPriority = true;
                
                expr.push(op);
                expr.push(Math.floor(Math.random() * 15) + 1);
            }
            
            // Parentesi chiusa
            expr.push(')');
            
            // Parte finale (dopo le parentesi) - con possibili √ó e √∑
            const afterLength = Math.floor(Math.random() * 2) + 1;
            for (let i = 0; i < afterLength; i++) {
                // Mix di operazioni anche fuori dalle parentesi
                const op = Math.random() < 0.5 ?
                    operations[Math.floor(Math.random() * operations.length)] :
                    ['+', '-'][Math.floor(Math.random() * 2)];
                expr.push(op);
                expr.push(Math.floor(Math.random() * 15) + 1);
            }
            
            return expr;
        }

        function generateExpressionLevel3() {
            const operations = ['+', '-', '√ó', '√∑'];
            let expr = [];
            
            // Decidi il tipo di struttura: 
            // 1. Solo quadre (40%)
            // 2. Quadre con tonde dentro (40%)
            // 3. Solo tonde (20%)
            const structure = Math.random();
            
            if (structure < 0.4) {
                // Solo parentesi quadre
                expr.push(Math.floor(Math.random() * 20) + 1);
                expr.push(operations[Math.floor(Math.random() * operations.length)]);
                
                // Parentesi quadra aperta
                expr.push('[');
                
                // Contenuto delle quadre (2-3 operazioni)
                const insideLength = Math.floor(Math.random() * 2) + 2;
                expr.push(Math.floor(Math.random() * 15) + 1);
                
                for (let i = 0; i < insideLength; i++) {
                    // Mix di operazioni nelle quadre
                    const op = Math.random() < 0.5 ? 
                        ['√ó', '√∑'][Math.floor(Math.random() * 2)] : 
                        ['+', '-'][Math.floor(Math.random() * 2)];
                    expr.push(op);
                    expr.push(Math.floor(Math.random() * 15) + 1);
                }
                
                // Parentesi quadra chiusa
                expr.push(']');
                
                // Parte finale
                expr.push(operations[Math.floor(Math.random() * operations.length)]);
                expr.push(Math.floor(Math.random() * 15) + 1);
                
            } else if (structure < 0.8) {
                // Quadre con tonde dentro
                expr.push(Math.floor(Math.random() * 20) + 1);
                expr.push(operations[Math.floor(Math.random() * operations.length)]);
                
                // Parentesi quadra aperta
                expr.push('[');
                
                // Prima parte dentro le quadre
                expr.push(Math.floor(Math.random() * 15) + 1);
                expr.push(['+', '-'][Math.floor(Math.random() * 2)]);
                
                // Parentesi tonde dentro le quadre
                expr.push('(');
                expr.push(Math.floor(Math.random() * 10) + 1);
                
                // 1-2 operazioni dentro le tonde
                const tondeLength = Math.floor(Math.random() * 2) + 1;
                for (let i = 0; i < tondeLength; i++) {
                    const op = operations[Math.floor(Math.random() * operations.length)];
                    expr.push(op);
                    expr.push(Math.floor(Math.random() * 10) + 1);
                }
                
                expr.push(')');
                
                // Operazione dopo le tonde, ancora dentro le quadre
                // Buona probabilit√† di √ó o √∑ qui per rendere interessante
                const opAfterRound = Math.random() < 0.7 ? 
                    ['√ó', '√∑'][Math.floor(Math.random() * 2)] : 
                    ['+', '-'][Math.floor(Math.random() * 2)];
                expr.push(opAfterRound);
                expr.push(Math.floor(Math.random() * 15) + 1);
                
                // Parentesi quadra chiusa
                expr.push(']');
                
                // Parte finale
                expr.push(operations[Math.floor(Math.random() * operations.length)]);
                expr.push(Math.floor(Math.random() * 15) + 1);
                
            } else {
                // Solo tonde (come livello 2)
                expr.push(Math.floor(Math.random() * 20) + 1);
                expr.push(operations[Math.floor(Math.random() * operations.length)]);
                
                expr.push('(');
                
                const insideLength = Math.floor(Math.random() * 2) + 2;
                expr.push(Math.floor(Math.random() * 15) + 1);
                
                for (let i = 0; i < insideLength; i++) {
                    const op = Math.random() < 0.4 ? 
                        ['√ó', '√∑'][Math.floor(Math.random() * 2)] : 
                        ['+', '-'][Math.floor(Math.random() * 2)];
                    expr.push(op);
                    expr.push(Math.floor(Math.random() * 15) + 1);
                }
                
                expr.push(')');
                
                expr.push(operations[Math.floor(Math.random() * operations.length)]);
                expr.push(Math.floor(Math.random() * 15) + 1);
            }
            
            return expr;
        }

        function generateExpression() {
            if (currentLevel === 1) {
                return generateExpressionLevel1();
            } else if (currentLevel === 2) {
                return generateExpressionLevel2();
            } else if (currentLevel === 3) {
                return generateExpressionLevel3();
            }
        }

        function findPriorityOperations(expr) {
            const groups = [];
            
            if (currentLevel === 1) {
                // Livello 1: trova tutte le √ó e √∑
                for (let i = 1; i < expr.length; i += 2) {
                    if (expr[i] === '√ó' || expr[i] === '√∑') {
                        groups.push([i-1, i, i+1]);
                    }
                }
            } else if (currentLevel === 2) {
                // Livello 2: trova √ó e √∑ SOLO dentro le parentesi tonde
                let insideParentheses = false;
                let hasPriorityInParentheses = false;
                
                // Prima verifica se ci sono √ó o √∑ nelle parentesi
                for (let i = 0; i < expr.length; i++) {
                    if (expr[i] === '(') {
                        insideParentheses = true;
                    } else if (expr[i] === ')') {
                        insideParentheses = false;
                    } else if (insideParentheses && (expr[i] === '√ó' || expr[i] === '√∑')) {
                        hasPriorityInParentheses = true;
                    }
                }
                
                // Poi trova le operazioni da evidenziare
                insideParentheses = false;
                for (let i = 0; i < expr.length; i++) {
                    if (expr[i] === '(') {
                        insideParentheses = true;
                    } else if (expr[i] === ')') {
                        insideParentheses = false;
                    } else if (insideParentheses) {
                        if (hasPriorityInParentheses) {
                            // Se ci sono √ó o √∑, evidenzia solo quelle
                            if (expr[i] === '√ó' || expr[i] === '√∑') {
                                groups.push([i-1, i, i+1]);
                            }
                        } else {
                            // Se non ci sono √ó o √∑, evidenzia tutte le operazioni nelle parentesi
                            if (expr[i] === '+' || expr[i] === '-') {
                                groups.push([i-1, i, i+1]);
                            }
                        }
                    }
                }
            } else if (currentLevel === 3) {
                // Livello 3: 
                // - Se ci sono tonde () ‚Üí lavora DENTRO le tonde
                // - Se ci sono SOLO quadre [] (senza tonde) ‚Üí lavora DENTRO le quadre
                // - Altrimenti ‚Üí come livello 1
                
                let hasRound = expr.includes('(');
                let hasSquare = expr.includes('[');
                
                const isOperator = (token) => ['+', '-', '√ó', '√∑'].includes(token);
                
                if (hasRound) {
                    // CI SONO TONDE: lavora dentro le tonde (non importa se dentro/fuori quadre)
                    let insideRound = false;
                    let hasPriorityInRound = false;
                    
                    // Prima passa: verifica se ci sono √ó o √∑ dentro le tonde
                    for (let i = 0; i < expr.length; i++) {
                        if (expr[i] === '(') {
                            insideRound = true;
                        } else if (expr[i] === ')') {
                            insideRound = false;
                        } else if (insideRound && (expr[i] === '√ó' || expr[i] === '√∑')) {
                            hasPriorityInRound = true;
                        }
                    }
                    
                    // Seconda passa: trova le operazioni da evidenziare dentro le tonde
                    insideRound = false;
                    for (let i = 0; i < expr.length; i++) {
                        if (expr[i] === '(') {
                            insideRound = true;
                        } else if (expr[i] === ')') {
                            insideRound = false;
                        } else if (insideRound && isOperator(expr[i])) {
                            if (hasPriorityInRound) {
                                // Se ci sono √ó o √∑, evidenzia solo quelle
                                if (expr[i] === '√ó' || expr[i] === '√∑') {
                                    groups.push([i-1, i, i+1]);
                                }
                            } else {
                                // Se non ci sono √ó o √∑, evidenzia tutte le operazioni
                                groups.push([i-1, i, i+1]);
                            }
                        }
                    }
                    
                } else if (hasSquare) {
                    // SOLO QUADRE (senza tonde): lavora dentro le quadre
                    let insideSquare = false;
                    let hasPriorityInSquare = false;
                    
                    // Prima passa: verifica se ci sono √ó o √∑ dentro le quadre
                    for (let i = 0; i < expr.length; i++) {
                        if (expr[i] === '[') {
                            insideSquare = true;
                        } else if (expr[i] === ']') {
                            insideSquare = false;
                        } else if (insideSquare && (expr[i] === '√ó' || expr[i] === '√∑')) {
                            hasPriorityInSquare = true;
                        }
                    }
                    
                    // Seconda passa: trova le operazioni da evidenziare dentro le quadre
                    insideSquare = false;
                    for (let i = 0; i < expr.length; i++) {
                        if (expr[i] === '[') {
                            insideSquare = true;
                        } else if (expr[i] === ']') {
                            insideSquare = false;
                        } else if (insideSquare && isOperator(expr[i])) {
                            if (hasPriorityInSquare) {
                                // Se ci sono √ó o √∑, evidenzia solo quelle
                                if (expr[i] === '√ó' || expr[i] === '√∑') {
                                    groups.push([i-1, i, i+1]);
                                }
                            } else {
                                // Se non ci sono √ó o √∑, evidenzia tutte le operazioni
                                groups.push([i-1, i, i+1]);
                            }
                        }
                    }
                    
                } else {
                    // Nessuna parentesi: come livello 1
                    for (let i = 0; i < expr.length; i++) {
                        if (expr[i] === '√ó' || expr[i] === '√∑') {
                            groups.push([i-1, i, i+1]);
                        }
                    }
                }
            }
            
            return groups;
        }
        //#endregion

        //#region Rendering e Interazione
        function renderExpression() {
            const container = document.getElementById('expression');
            container.innerHTML = '';
            
            let insideParentheses = false;
            let insideSquareBrackets = false;
            
            currentExpression.forEach((token, index) => {
                const span = document.createElement('span');
                span.className = 'token';
                span.textContent = token;
                span.dataset.index = index;
                
                // Gestione parentesi
                if (token === '(') {
                    span.className += ' parenthesis round open';
                    insideParentheses = true;
                } else if (token === ')') {
                    span.className += ' parenthesis round close';
                    insideParentheses = false;
                } else if (token === '[') {
                    span.className += ' parenthesis square open';
                    insideSquareBrackets = true;
                } else if (token === ']') {
                    span.className += ' parenthesis square close';
                    insideSquareBrackets = false;
                } else {
                    // Token normale (numero o operatore)
                    if (currentLevel === 2 && insideParentheses) {
                        span.className += ' inside-parentheses';
                    } else if (currentLevel === 3) {
                        // Nel livello 3: evidenzia le tonde se presenti, altrimenti le quadre
                        if (insideParentheses) {
                            span.className += ' inside-parentheses';
                        } else if (insideSquareBrackets) {
                            span.className += ' inside-square-brackets';
                        }
                    }
                    // Aggiungi onclick solo ai token non-parentesi
                    span.onclick = () => toggleSelection(index);
                }
                
                container.appendChild(span);
            });
        }

        function toggleSelection(index) {
            // Non permettere selezione di parentesi
            if (currentExpression[index] === '(' || currentExpression[index] === ')' ||
                currentExpression[index] === '[' || currentExpression[index] === ']') {
                return;
            }
            
            const token = document.querySelector(`[data-index="${index}"]`);
            
            if (selectedTokens.has(index)) {
                selectedTokens.delete(index);
                token.classList.remove('selected');
            } else {
                selectedTokens.add(index);
                token.classList.add('selected');
            }
        }

        function resetSelection() {
            selectedTokens.clear();
            document.querySelectorAll('.token').forEach(token => {
                token.classList.remove('selected', 'correct', 'incorrect');
            });
            
            let feedbackText;
            if (currentLevel === 1) {
                feedbackText = 'Seleziona TUTTE le operazioni da svolgere per prime';
            } else if (currentLevel === 2) {
                feedbackText = 'Seleziona TUTTE le operazioni da svolgere dentro le parentesi';
            } else if (currentLevel === 3) {
                const hasRound = currentExpression.includes('(');
                if (hasRound) {
                    feedbackText = 'Seleziona TUTTE le operazioni dentro le tonde ()';
                } else {
                    feedbackText = 'Seleziona TUTTE le operazioni dentro le quadre []';
                }
            }
                
            document.getElementById('feedback').textContent = feedbackText;
            document.getElementById('feedback').className = 'feedback hint';
        }
        //#endregion

        //#region Verifica e Feedback
        function verifySelection() {
            stats.attempts++;
            updateStats();
            
            let isCorrect = false;
            
            if (correctGroups.length === 0) {
                // Non ci sono operazioni prioritarie - corretto se non ha selezionato nulla
                isCorrect = selectedTokens.size === 0;
            } else {
                // Ci sono operazioni prioritarie
                // Lo studente deve selezionare TUTTI i gruppi corretti, n√© pi√π n√© meno
                
                // Crea set di tutti i token che DEVONO essere selezionati
                let requiredTokens = new Set();
                correctGroups.forEach(group => {
                    group.forEach(idx => requiredTokens.add(idx));
                });
                
                // Verifica: selezione deve corrispondere esattamente ai token richiesti
                if (selectedTokens.size === requiredTokens.size) {
                    isCorrect = true;
                    for (let token of selectedTokens) {
                        if (!requiredTokens.has(token)) {
                            isCorrect = false;
                            break;
                        }
                    }
                }
            }
            
            if (isCorrect) {
                handleCorrect();
            } else {
                handleIncorrect();
            }
        }

        function handleCorrect() {
            stats.correct++;
            stats.streak++;
            updateStats();
            
            // Registra nel sistema di certificazione
            recordCorrectAnswer();
            updateCertStats();
            
            document.querySelectorAll('.token.selected').forEach(token => {
                token.classList.add('correct');
                token.classList.remove('selected');
            });
            
            const feedback = document.getElementById('feedback');
            
            if (correctGroups.length === 0) {
                feedback.textContent = 'üéâ Perfetto! Non c\'erano operazioni prioritarie da evidenziare!';
            } else {
                feedback.textContent = 'üéâ Eccellente! Hai identificato tutte le operazioni prioritarie!';
            }
            
            feedback.className = 'feedback success';
            
            document.querySelector('.btn-verify').style.display = 'none';
            document.querySelector('.btn-reset').style.display = 'none';
            document.querySelector('.btn-next').style.display = 'inline-block';
            
            playSound('success');
        }

        function handleIncorrect() {
            stats.streak = 0;
            updateStats();
            
            // Registra errore nel sistema di certificazione
            recordError();
            
            document.querySelectorAll('.token.selected').forEach(token => {
                token.classList.add('incorrect');
            });
            
            const feedback = document.getElementById('feedback');
            
            // Conta quante operazioni prioritarie ci sono
            const totalPriority = correctGroups.length;
            
            // Conta quante ne ha selezionate correttamente
            let requiredTokens = new Set();
            correctGroups.forEach(group => {
                group.forEach(idx => requiredTokens.add(idx));
            });
            
            let correctlySelected = 0;
            let wronglySelected = 0;
            for (let token of selectedTokens) {
                if (requiredTokens.has(token)) {
                    correctlySelected++;
                } else {
                    wronglySelected++;
                }
            }
            
            if (currentLevel === 1) {
                if (selectedTokens.size === 0 && correctGroups.length > 0) {
                    feedback.textContent = '‚ùå Non hai selezionato nulla! Cerca le √ó e √∑';
                } else if (correctGroups.length === 0 && selectedTokens.size > 0) {
                    feedback.textContent = '‚ùå Non ci sono √ó o √∑ da selezionare!';
                } else if (wronglySelected > 0) {
                    feedback.textContent = '‚ùå Hai selezionato operazioni sbagliate! Solo √ó e √∑';
                } else if (correctlySelected < requiredTokens.size) {
                    feedback.textContent = `‚ùå Mancano delle operazioni! Ci sono ${totalPriority} operazioni prioritarie da selezionare`;
                } else {
                    feedback.textContent = '‚ùå Ricorda: seleziona numero-operatore-numero per √ó e √∑';
                }
            } else if (currentLevel === 2) {
                if (selectedTokens.size === 0 && correctGroups.length > 0) {
                    feedback.textContent = '‚ùå Cerca le operazioni DENTRO le parentesi!';
                } else if (correctGroups.length === 0 && selectedTokens.size > 0) {
                    feedback.textContent = '‚ùå Non ci sono operazioni prioritarie dentro le parentesi!';
                } else if (wronglySelected > 0) {
                    feedback.textContent = '‚ùå Hai selezionato operazioni fuori dalle parentesi!';
                } else if (correctlySelected < requiredTokens.size) {
                    feedback.textContent = `‚ùå Mancano delle operazioni! Seleziona TUTTE le operazioni prioritarie nelle parentesi`;
                } else {
                    feedback.textContent = '‚ùå Seleziona TUTTE le operazioni dentro le parentesi!';
                }
            } else if (currentLevel === 3) {
                const hasRound = currentExpression.includes('(');
                const hasSquare = currentExpression.includes('[');
                if (selectedTokens.size === 0 && correctGroups.length > 0) {
                    if (hasRound) {
                        feedback.textContent = '‚ùå Ci sono le tonde! Cerca le operazioni DENTRO le tonde';
                    } else if (hasSquare) {
                        feedback.textContent = '‚ùå Cerca le operazioni dentro le quadre!';
                    } else {
                        feedback.textContent = '‚ùå Cerca le √ó e √∑!';
                    }
                } else if (correctGroups.length === 0 && selectedTokens.size > 0) {
                    feedback.textContent = '‚ùå Non ci sono operazioni prioritarie da evidenziare!';
                } else if (wronglySelected > 0) {
                    if (hasRound) {
                        feedback.textContent = '‚ùå Ci sono le tonde! Seleziona SOLO operazioni dentro le tonde';
                    } else if (hasSquare) {
                        feedback.textContent = '‚ùå Seleziona SOLO operazioni dentro le quadre!';
                    } else {
                        feedback.textContent = '‚ùå Hai selezionato operazioni sbagliate!';
                    }
                } else if (correctlySelected < requiredTokens.size) {
                    feedback.textContent = `‚ùå Mancano delle operazioni! Seleziona TUTTE le operazioni prioritarie`;
                } else {
                    if (hasRound) {
                        feedback.textContent = '‚ùå Seleziona TUTTE le operazioni dentro le tonde!';
                    } else if (hasSquare) {
                        feedback.textContent = '‚ùå Seleziona TUTTE le operazioni dentro le quadre!';
                    } else {
                        feedback.textContent = '‚ùå Seleziona TUTTE le √ó e √∑!';
                    }
                }
            }
            
            feedback.className = 'feedback error';
            
            setTimeout(() => {
                document.querySelectorAll('.token.incorrect').forEach(token => {
                    token.classList.remove('incorrect');
                });
            }, 1000);
            
            playSound('error');
        }
        //#endregion

        //#region Utilities e Stats
        function updateStats() {
            document.getElementById('correct').textContent = stats.correct;
            document.getElementById('attempts').textContent = stats.attempts;
            document.getElementById('streak').textContent = stats.streak;
            
            const progress = exerciseCount > 0 ? (stats.correct / exerciseCount) * 100 : 0;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function playSound(type) {
            // Placeholder per i suoni - implementare se necessario
        }

        function nextExercise() {
            selectedTokens.clear();
            
            // Ripristina i pulsanti PRIMA di inizializzare l'esercizio
            document.querySelector('.btn-verify').style.display = 'inline-block';
            document.querySelector('.btn-reset').style.display = 'inline-block';
            document.querySelector('.btn-next').style.display = 'none';
            
            // Rimuovi eventuali classi residue dai token
            document.querySelectorAll('.token').forEach(token => {
                token.classList.remove('selected', 'correct', 'incorrect');
                token.style.border = '';
                token.style.opacity = '';
            });
            
            initExercise();
        }

        function initExercise() {
            exerciseCount++;
            currentExpression = generateExpression();
            correctGroups = findPriorityOperations(currentExpression);
            renderExpression();
            
            let feedbackText;
            if (currentLevel === 1) {
                feedbackText = 'Seleziona TUTTE le operazioni da svolgere per prime';
            } else if (currentLevel === 2) {
                feedbackText = 'Seleziona TUTTE le operazioni da svolgere dentro le parentesi';
            } else if (currentLevel === 3) {
                const hasRound = currentExpression.includes('(');
                if (hasRound) {
                    feedbackText = 'Seleziona TUTTE le operazioni dentro le tonde ()';
                } else {
                    feedbackText = 'Seleziona TUTTE le operazioni dentro le quadre []';
                }
            }
                
            document.getElementById('feedback').textContent = feedbackText;
            document.getElementById('feedback').className = 'feedback hint';
        }
        //#endregion

        // Inizializzazione
        window.onload = () => {
            // Inizializza sistema certificazione
            initCertSystem();
            
            // Renderizza pannello certificato
            if (certSystem) {
                certSystem.renderFullPanel('certificatePanel', {
                    collapsible: true,
                    showClassroomToggle: true,
                    showVerificationToggle: true
                });
            }
            
            updateInstructions();
            initExercise();
            updateStats();
        };
    </script>
</body>
</html>
