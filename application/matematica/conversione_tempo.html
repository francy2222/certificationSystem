<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misure di Tempo - Conversioni</title>
    
    <!-- Sistema Certificazione -->
    <script src="https://certificationsystem.netlify.app/certification-system.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #764ba2;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .level-indicator {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
        }

        /* Livello 1 e 2 - Abbinamenti */
        .matching-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .matching-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .matching-item {
            padding: 20px;
            background: #f8f9fa;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.3em;
            text-align: center;
            font-weight: bold;
        }

        .matching-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }

        .matching-item.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .matching-item.correct {
            background: #28a745;
            color: white;
            border-color: #28a745;
            pointer-events: none;
        }

        .matching-item.wrong {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Livello 3 - Conversioni */
        .exercise {
            text-align: center;
            font-size: 2em;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            font-weight: bold;
            color: #333;
        }

        .schema-container {
            display: none;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .schema-container.active {
            display: block;
        }

        .schema-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin: 20px 0;
        }

        .unit-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .arrow-top, .arrow-bottom {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            color: #666;
            font-weight: bold;
            visibility: hidden;
        }

        .arrow-top.visible, .arrow-bottom.visible {
            visibility: visible;
        }

        .unit-box {
            padding: 15px 20px;
            background: white;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
            font-weight: bold;
            min-width: 90px;
            text-align: center;
        }

        .unit-box:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .unit-box.selected-start {
            background: #ffd700;
            border-color: #ffd700;
            color: #000;
        }

        .unit-box.selected-end {
            background: #87ceeb;
            border-color: #87ceeb;
            color: #000;
        }

        .arrows-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .arrow-option {
            padding: 15px 30px;
            background: white;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.3em;
            font-weight: bold;
        }

        .arrow-option:hover {
            transform: scale(1.05);
            border-color: #667eea;
        }

        .arrow-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .calculator {
            display: none;
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .calculator.active {
            display: block;
        }

        .calc-display {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-align: center;
            border: 3px solid #dee2e6;
            min-height: 60px;
            font-weight: bold;
        }

        .calc-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .calc-btn {
            padding: 20px;
            background: white;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.3em;
            font-weight: bold;
        }

        .calc-btn:hover {
            transform: scale(1.05);
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .calc-btn:active {
            transform: scale(0.95);
        }

        .result-section {
            display: none;
            margin-top: 20px;
            text-align: center;
        }

        .result-section.active {
            display: block;
        }

        .result-input {
            padding: 15px;
            font-size: 1.5em;
            border: 3px solid #dee2e6;
            border-radius: 10px;
            width: 200px;
            text-align: center;
            margin: 20px auto;
            display: block;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .btn-container {
            text-align: center;
            margin-top: 30px;
        }

        .feedback {
            text-align: center;
            font-size: 1.5em;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            font-weight: bold;
        }

        .feedback.correct {
            background: #d4edda;
            color: #155724;
        }

        .feedback.wrong {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-fill {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⏱️ Misure di Tempo</h1>
        <div class="subtitle">Impara a convertire le unità di tempo</div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar">0%</div>
        </div>

        <div class="level-indicator" id="levelIndicator">
            Livello 1: Riconoscimento Simboli
        </div>

        <!-- LIVELLO 1: Simboli -->
        <div id="level1" class="level-content">
            <p style="text-align: center; font-size: 1.2em; margin-bottom: 20px;">
                Abbina ogni simbolo con il suo significato
            </p>
            <div class="matching-container" id="matchingLevel1"></div>
        </div>

        <!-- LIVELLO 2: Equivalenze -->
        <div id="level2" class="level-content" style="display: none;">
            <p style="text-align: center; font-size: 1.2em; margin-bottom: 20px;">
                Abbina ogni unità di tempo con la sua equivalenza
            </p>
            <div class="matching-container" id="matchingLevel2"></div>
        </div>

        <!-- LIVELLO 3: Conversioni -->
        <div id="level3" class="level-content" style="display: none;">
            <div class="exercise" id="exerciseText"></div>
            
            <div class="schema-container" id="schemaContainer">
                <p style="text-align: center; margin-bottom: 15px; font-size: 1.2em; font-weight: bold;">
                    1. Seleziona l'unità di PARTENZA (giallo) e quella di ARRIVO (azzurro)
                </p>
                <div id="schemaRow" class="schema-row"></div>
                
                <div id="arrowsSection" style="display: none;">
                    <p style="text-align: center; margin: 20px 0; font-size: 1.2em; font-weight: bold;">
                        2. Scegli la direzione delle frecce (moltiplichi o dividi?)
                    </p>
                    <div class="arrows-container">
                        <div class="arrow-option" data-direction="multiply">
                            ⬇️ Moltiplica (verso il piccolo)
                        </div>
                        <div class="arrow-option" data-direction="divide">
                            ⬆️ Dividi (verso il grande)
                        </div>
                    </div>
                </div>
            </div>

            <div class="calculator" id="calculator">
                <p style="text-align: center; margin-bottom: 15px; font-size: 1.2em; font-weight: bold;">
                    3. Usa la calcolatrice per fare il calcolo
                </p>
                <div class="calc-display" id="calcDisplay">Pronto</div>
                <div class="calc-buttons" id="calcButtons"></div>
            </div>

            <div class="result-section" id="resultSection">
                <p style="font-size: 1.2em; font-weight: bold; margin-bottom: 10px;">
                    Inserisci il risultato:
                </p>
                <input type="number" id="resultInput" class="result-input" placeholder="?">
                <div class="btn-container">
                    <button class="btn btn-success" onclick="checkResult()">Verifica Risposta</button>
                </div>
            </div>

            <div id="feedback"></div>
        </div>

        <div class="btn-container" id="nextButton" style="display: none;">
            <button class="btn btn-primary" onclick="nextExercise()">Prossimo Esercizio ➡️</button>
        </div>

        <!-- Pannello Certificazione -->
        <div id="certificateContainer" style="margin-top: 40px;"></div>
    </div>

    <script>
        //#region Dati e Configurazione
        const symbolsData = [
            { symbol: 'g', name: 'giorno' },
            { symbol: 'h', name: 'ora' },
            { symbol: 'm', name: 'minuto' },
            { symbol: 's', name: 'secondo' },
            { symbol: 'ds', name: 'decimo di secondo' },
            { symbol: 'cs', name: 'centesimo di secondo' },
            { symbol: 'ms', name: 'millisecondo' }
        ];

        const equivalencesData = [
            { left: '1 giorno', right: '24 ore', leftId: 0 },
            { left: '1 ora', right: '60 minuti', leftId: 1 },
            { left: '1 minuto', right: '60 secondi', leftId: 2 },
            { left: '1 secondo', right: '10 ds', leftId: 3 },
            { left: '1 secondo', right: '100 cs', leftId: 3 },  // Stesso leftId!
            { left: '1 secondo', right: '1000 ms', leftId: 3 }  // Stesso leftId!
        ];

        // Mappa degli abbinamenti corretti (leftId -> array di rightId validi)
        const validMatches = {
            0: [0],      // 1 giorno -> 24 ore
            1: [1],      // 1 ora -> 60 minuti
            2: [2],      // 1 minuto -> 60 secondi
            3: [3, 4, 5] // 1 secondo -> 10 ds, 100 cs, 1000 ms (tutti validi!)
        };

        const conversionUnits = [
            { name: 'g', factor: 1, label: 'giorno (g)' },
            { name: 'h', factor: 24, label: 'ora (h)' },
            { name: 'm', factor: 60, label: 'minuto (m)' },
            { name: 's', factor: 60, label: 'secondo (s)' },
            { name: 'ds', factor: 10, label: 'decimo (ds)' },
            { name: 'cs', factor: 10, label: 'centesimo (cs)' },
            { name: 'ms', factor: 10, label: 'millisecondo (ms)' }
        ];

        let currentLevel = 1;
        let level1Matches = {};
        let level2Matches = {};
        let selectedLeft = null;
        let currentExercise = null;
        let selectedStart = null;
        let selectedEnd = null;
        let selectedDirection = null;
        let currentValue = null;
        let calculationSteps = [];
        let exerciseCount = 0;
        let certSystem = null;
        let totalErrors = 0;
        let level1Attempts = 0;
        let level2Attempts = 0;
        //#endregion

        //#region Livello 1 - Simboli
        function initLevel1() {
            const container = document.getElementById('matchingLevel1');
            container.innerHTML = '';
            
            const leftCol = document.createElement('div');
            leftCol.className = 'matching-column';
            const rightCol = document.createElement('div');
            rightCol.className = 'matching-column';

            // Crea array mescolato per la colonna destra
            const shuffledNames = [...symbolsData].sort(() => Math.random() - 0.5);

            symbolsData.forEach((item, index) => {
                const leftItem = document.createElement('div');
                leftItem.className = 'matching-item';
                leftItem.textContent = item.symbol;
                leftItem.dataset.id = index;
                leftItem.dataset.side = 'left';
                leftItem.onclick = () => selectMatchingItem(leftItem, 1);
                leftCol.appendChild(leftItem);
            });

            shuffledNames.forEach((item, index) => {
                const rightItem = document.createElement('div');
                rightItem.className = 'matching-item';
                rightItem.textContent = item.name;
                rightItem.dataset.id = symbolsData.findIndex(s => s.name === item.name);
                rightItem.dataset.side = 'right';
                rightItem.onclick = () => selectMatchingItem(rightItem, 1);
                rightCol.appendChild(rightItem);
            });

            container.appendChild(leftCol);
            container.appendChild(rightCol);
        }
        //#endregion

        //#region Livello 2 - Equivalenze
        function initLevel2() {
            const container = document.getElementById('matchingLevel2');
            container.innerHTML = '';
            
            const leftCol = document.createElement('div');
            leftCol.className = 'matching-column';
            const rightCol = document.createElement('div');
            rightCol.className = 'matching-column';

            // Crea array mescolato per la colonna destra
            const shuffledEquivalences = [...equivalencesData].sort(() => Math.random() - 0.5);

            // Crea colonna sinistra (con leftId univoci ma alcuni testi ripetuti)
            const leftItems = [];
            const seenLeftIds = new Set();
            
            equivalencesData.forEach((item, index) => {
                if (!seenLeftIds.has(item.leftId)) {
                    seenLeftIds.add(item.leftId);
                    leftItems.push({
                        text: item.left,
                        leftId: item.leftId,
                        rightIndex: index
                    });
                }
            });

            leftItems.forEach(item => {
                const leftItem = document.createElement('div');
                leftItem.className = 'matching-item';
                leftItem.textContent = item.text;
                leftItem.dataset.leftId = item.leftId;
                leftItem.dataset.side = 'left';
                leftItem.onclick = () => selectMatchingItem(leftItem, 2);
                leftCol.appendChild(leftItem);
            });

            shuffledEquivalences.forEach((item, index) => {
                const rightItem = document.createElement('div');
                rightItem.className = 'matching-item';
                rightItem.textContent = item.right;
                rightItem.dataset.rightId = equivalencesData.findIndex(e => e.right === item.right);
                rightItem.dataset.side = 'right';
                rightItem.onclick = () => selectMatchingItem(rightItem, 2);
                rightCol.appendChild(rightItem);
            });

            container.appendChild(leftCol);
            container.appendChild(rightCol);
        }
        //#endregion

        //#region Gestione Abbinamenti
        function selectMatchingItem(element, level) {
            if (element.classList.contains('correct')) return;

            const side = element.dataset.side;

            if (level === 1) {
                // Livello 1 - logica originale
                const id = element.dataset.id;
                
                if (side === 'left') {
                    document.querySelectorAll(`#matchingLevel1 .matching-item[data-side="left"]`).forEach(el => {
                        el.classList.remove('selected');
                    });
                    element.classList.add('selected');
                    selectedLeft = id;
                } else {
                    if (selectedLeft === null) return;

                    if (selectedLeft === id) {
                        // Corretto!
                        element.classList.add('correct');
                        const leftElement = document.querySelector(`#matchingLevel1 .matching-item[data-side="left"][data-id="${id}"]`);
                        leftElement.classList.remove('selected');
                        leftElement.classList.add('correct');
                        
                        level1Matches[id] = true;
                        if (Object.keys(level1Matches).length === symbolsData.length) {
                            setTimeout(() => completeLevel1(), 500);
                        }
                        selectedLeft = null;
                    } else {
                        // Sbagliato!
                        element.classList.add('wrong');
                        setTimeout(() => {
                            element.classList.remove('wrong');
                            resetLevel(1);
                        }, 1000);
                    }
                }
            } else {
                // Livello 2 - logica con abbinamenti multipli
                if (side === 'left') {
                    const leftId = element.dataset.leftId;
                    document.querySelectorAll(`#matchingLevel2 .matching-item[data-side="left"]`).forEach(el => {
                        el.classList.remove('selected');
                    });
                    element.classList.add('selected');
                    selectedLeft = leftId;
                } else {
                    if (selectedLeft === null) return;
                    
                    const rightId = parseInt(element.dataset.rightId);
                    
                    // Verifica se l'abbinamento è valido
                    if (validMatches[selectedLeft] && validMatches[selectedLeft].includes(rightId)) {
                        // Corretto!
                        element.classList.add('correct');
                        const leftElement = document.querySelector(`#matchingLevel2 .matching-item[data-side="left"][data-left-id="${selectedLeft}"]`);
                        leftElement.classList.remove('selected');
                        
                        // Non rendere "correct" il left se può ancora essere abbinato ad altre risposte
                        const remainingMatches = validMatches[selectedLeft].filter(rid => {
                            const rightEl = document.querySelector(`#matchingLevel2 .matching-item[data-side="right"][data-right-id="${rid}"]`);
                            return rightEl && !rightEl.classList.contains('correct');
                        });
                        
                        if (remainingMatches.length === 0) {
                            leftElement.classList.add('correct');
                        }
                        
                        level2Matches[rightId] = true;
                        if (Object.keys(level2Matches).length === equivalencesData.length) {
                            setTimeout(() => completeLevel2(), 500);
                        }
                        selectedLeft = null;
                    } else {
                        // Sbagliato!
                        element.classList.add('wrong');
                        setTimeout(() => {
                            element.classList.remove('wrong');
                            resetLevel(2);
                        }, 1000);
                    }
                }
            }
        }

        function resetLevel(level) {
            if (level === 1) {
                level1Matches = {};
                selectedLeft = null;
                initLevel1();
                level1Attempts++;
                certSystem.incrementField('lvl1_retry');
                certSystem.incrementField('errors');
            } else {
                level2Matches = {};
                selectedLeft = null;
                initLevel2();
                level2Attempts++;
                certSystem.incrementField('lvl2_retry');
                certSystem.incrementField('errors');
            }
        }
        //#endregion

        //#region Completamento Livelli
        function completeLevel1() {
            currentLevel = 2;
            document.getElementById('level1').style.display = 'none';
            document.getElementById('level2').style.display = 'block';
            document.getElementById('levelIndicator').textContent = 'Livello 2: Equivalenze di Tempo';
            updateProgress(33);
            initLevel2();
            
            // Tracking certificazione
            certSystem.incrementField('lvl1_comp');
        }

        function completeLevel2() {
            currentLevel = 3;
            document.getElementById('level2').style.display = 'none';
            document.getElementById('level3').style.display = 'block';
            document.getElementById('levelIndicator').textContent = 'Livello 3: Conversioni Guidate';
            updateProgress(66);
            generateExercise();
            
            // Tracking certificazione
            certSystem.incrementField('lvl2_comp');
        }
        //#endregion

        //#region Livello 3 - Conversioni
        function generateExercise() {
            exerciseCount++;
            // Reset interfaccia
            selectedStart = null;
            selectedEnd = null;
            selectedDirection = null;
            currentValue = null;
            calculationSteps = [];
            
            document.getElementById('schemaContainer').classList.add('active');
            document.getElementById('calculator').classList.remove('active');
            document.getElementById('resultSection').classList.remove('active');
            document.getElementById('nextButton').style.display = 'none';
            document.getElementById('feedback').innerHTML = '';
            document.getElementById('calcDisplay').textContent = 'Pronto';
            document.getElementById('resultInput').value = '';
            document.getElementById('arrowsSection').style.display = 'none';

            // Genera esercizio casuale
            const possibleConversions = [
                { value: 2, from: 'g', to: 'h', result: 48 },
                { value: 3, from: 'h', to: 'm', result: 180 },
                { value: 5, from: 'm', to: 's', result: 300 },
                { value: 10, from: 's', to: 'ds', result: 100 },
                { value: 2, from: 's', to: 'cs', result: 200 },
                { value: 3, from: 's', to: 'ms', result: 3000 },
                { value: 120, from: 'm', to: 'h', result: 2 },
                { value: 48, from: 'h', to: 'g', result: 2 },
                { value: 300, from: 's', to: 'm', result: 5 }
            ];

            currentExercise = possibleConversions[Math.floor(Math.random() * possibleConversions.length)];
            
            const fromUnit = conversionUnits.find(u => u.name === currentExercise.from);
            const toUnit = conversionUnits.find(u => u.name === currentExercise.to);
            
            // Nomi completi delle unità
            const unitNames = {
                'g': 'giorni',
                'h': 'ore',
                'm': 'minuti',
                's': 'secondi',
                'ds': 'decimi di secondo',
                'cs': 'centesimi di secondo',
                'ms': 'millisecondi'
            };
            
            document.getElementById('exerciseText').innerHTML = 
                `Converti:<br>${currentExercise.value} ${unitNames[currentExercise.from]} (${currentExercise.from}) = ? ${unitNames[currentExercise.to]} (${currentExercise.to})`;

            initUnitsSelection();
        }

        function initUnitsSelection() {
            const schemaRow = document.getElementById('schemaRow');
            schemaRow.innerHTML = '';

            conversionUnits.forEach((unit, index) => {
                const cell = document.createElement('div');
                cell.className = 'unit-cell';

                // Freccia superiore (moltiplicatori)
                const arrowTop = document.createElement('div');
                arrowTop.className = 'arrow-top';
                if (index > 0) {
                    arrowTop.textContent = `×${conversionUnits[index].factor}`;
                    arrowTop.innerHTML = `<div>↓</div><div style="font-size: 0.85em;">×${conversionUnits[index].factor}</div>`;
                }

                // Box unità
                const box = document.createElement('div');
                box.className = 'unit-box';
                box.textContent = unit.name;
                box.dataset.unit = unit.name;
                box.onclick = () => selectUnit(box, unit.name);

                // Freccia inferiore (divisori)
                const arrowBottom = document.createElement('div');
                arrowBottom.className = 'arrow-bottom';
                if (index > 0) {
                    arrowBottom.innerHTML = `<div style="font-size: 0.85em;">÷${conversionUnits[index].factor}</div><div>↑</div>`;
                }

                cell.appendChild(arrowTop);
                cell.appendChild(box);
                cell.appendChild(arrowBottom);
                schemaRow.appendChild(cell);
            });
        }

        function selectUnit(element, unitName) {
            if (!selectedStart) {
                // Prima selezione (partenza)
                document.querySelectorAll('.unit-box').forEach(el => el.classList.remove('selected-start'));
                element.classList.add('selected-start');
                selectedStart = unitName;
            } else if (!selectedEnd && unitName !== selectedStart) {
                // Seconda selezione (arrivo)
                element.classList.add('selected-end');
                selectedEnd = unitName;
                
                // Mostra le frecce nel percorso selezionato
                highlightPath(selectedStart, selectedEnd);
                
                document.getElementById('arrowsSection').style.display = 'block';
            }
        }

        function highlightPath(startUnit, endUnit) {
            const startIdx = conversionUnits.findIndex(u => u.name === startUnit);
            const endIdx = conversionUnits.findIndex(u => u.name === endUnit);
            
            // Rimuovi tutte le evidenziazioni precedenti
            document.querySelectorAll('.arrow-top, .arrow-bottom').forEach(el => {
                el.classList.remove('visible');
            });

            // Evidenzia le frecce nel percorso
            if (startIdx < endIdx) {
                // Stiamo andando verso il basso (moltiplicando)
                for (let i = startIdx + 1; i <= endIdx; i++) {
                    const cells = document.querySelectorAll('.unit-cell');
                    cells[i].querySelector('.arrow-top').classList.add('visible');
                }
            } else {
                // Stiamo andando verso l'alto (dividendo)
                for (let i = endIdx + 1; i <= startIdx; i++) {
                    const cells = document.querySelectorAll('.unit-cell');
                    cells[i].querySelector('.arrow-bottom').classList.add('visible');
                }
            }
        }

        // Selezione direzione frecce
        document.querySelectorAll('.arrow-option').forEach(arrow => {
            arrow.onclick = function() {
                document.querySelectorAll('.arrow-option').forEach(el => el.classList.remove('selected'));
                this.classList.add('selected');
                selectedDirection = this.dataset.direction;
                
                // Verifica se la selezione è corretta
                if (isSelectionCorrect()) {
                    setTimeout(() => {
                        document.getElementById('calculator').classList.add('active');
                        initCalculator();
                    }, 300);
                } else {
                    showFeedback('Ops! La direzione non è corretta per questa conversione. Riprova!', 'wrong');
                    setTimeout(() => {
                        resetLevel3();
                    }, 2000);
                }
            };
        });

        function isSelectionCorrect() {
            // Verifica che start e end corrispondano all'esercizio
            if (selectedStart !== currentExercise.from || selectedEnd !== currentExercise.to) {
                return false;
            }

            // Determina se dovrebbe moltiplicare o dividere
            const startIdx = conversionUnits.findIndex(u => u.name === selectedStart);
            const endIdx = conversionUnits.findIndex(u => u.name === selectedEnd);
            const shouldMultiply = endIdx > startIdx;

            return (shouldMultiply && selectedDirection === 'multiply') || 
                   (!shouldMultiply && selectedDirection === 'divide');
        }

        function initCalculator() {
            currentValue = currentExercise.value;
            calculationSteps = [];
            
            const calcButtons = document.getElementById('calcButtons');
            calcButtons.innerHTML = '';

            const operations = [
                { label: '×24', value: 24, type: 'multiply' },
                { label: '×60', value: 60, type: 'multiply' },
                { label: '×10', value: 10, type: 'multiply' },
                { label: '÷24', value: 24, type: 'divide' },
                { label: '÷60', value: 60, type: 'divide' },
                { label: '÷10', value: 10, type: 'divide' }
            ];

            operations.forEach(op => {
                const btn = document.createElement('button');
                btn.className = 'calc-btn';
                btn.textContent = op.label;
                btn.onclick = () => performCalculation(op);
                calcButtons.appendChild(btn);
            });

            updateCalcDisplay();
        }

        function performCalculation(operation) {
            if (operation.type === 'multiply') {
                currentValue *= operation.value;
            } else {
                currentValue /= operation.value;
            }

            calculationSteps.push(operation);
            updateCalcDisplay();

            // Mostra sezione risultato
            document.getElementById('resultSection').classList.add('active');
        }

        function updateCalcDisplay() {
            // Nomi delle unità
            const unitNames = {
                'g': 'giorni',
                'h': 'ore',
                'm': 'minuti',
                's': 'secondi',
                'ds': 'decimi',
                'cs': 'centesimi',
                'ms': 'millisecondi'
            };
            
            let display = `${currentExercise.value} ${unitNames[currentExercise.from]}`;
            
            if (calculationSteps.length === 0) {
                display += ' = ________';
            } else {
                calculationSteps.forEach(step => {
                    if (step.type === 'multiply') {
                        display += ` × ${step.value}`;
                    } else {
                        display += ` ÷ ${step.value}`;
                    }
                });
                display += ` = ${currentValue} ${unitNames[currentExercise.to]}`;
            }
            
            document.getElementById('calcDisplay').textContent = display;
        }

        function checkResult() {
            const userAnswer = parseFloat(document.getElementById('resultInput').value);
            
            if (userAnswer === currentExercise.result) {
                showFeedback('🎉 Esatto! Ottimo lavoro!', 'correct');
                document.getElementById('nextButton').style.display = 'block';
                
                // Tracking certificazione
                certSystem.incrementField('conversions');
                
                if (exerciseCount >= 5) {
                    updateProgress(100);
                    setTimeout(() => {
                        showFeedback('🏆 Complimenti! Hai completato tutti i livelli!', 'correct');
                        document.getElementById('nextButton').innerHTML = 
                            '<button class="btn btn-success" onclick="location.reload()">Ricomincia 🔄</button>';
                    }, 1500);
                }
            } else {
                showFeedback('❌ Non è corretto. Riprova dall\'inizio!', 'wrong');
                certSystem.incrementField('errors');
                setTimeout(() => resetLevel3(), 2000);
            }
        }

        function resetLevel3() {
            selectedStart = null;
            selectedEnd = null;
            selectedDirection = null;
            
            // Rimuovi selezioni
            document.querySelectorAll('.unit-box').forEach(el => {
                el.classList.remove('selected-start', 'selected-end');
            });
            
            // Nascondi frecce evidenziate
            document.querySelectorAll('.arrow-top, .arrow-bottom').forEach(el => {
                el.classList.remove('visible');
            });
            
            // Rimuovi selezione direzione
            document.querySelectorAll('.arrow-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            document.getElementById('arrowsSection').style.display = 'none';
            
            generateExercise();
        }

        function nextExercise() {
            updateProgress(66 + (exerciseCount * 6.8)); // Incremento progressivo dopo 66%
            generateExercise();
        }
        //#endregion

        //#region Utility
        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `feedback ${type}`;
        }

        function updateProgress(percentage) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
        }
        //#endregion

        //#region Sistema Certificazione
        function initCertSystem() {
            certSystem = new CertificationSystem({
                appName: 'Misure di Tempo',
                appVersion: '1.0.0',
                storageKey: 'misure_tempo_cert',
                certUrl: 'https://certificationsystem.netlify.app/',
                trackFocus: false,
                
                fields: [
                    { key: 'lvl1_comp', label: 'Livello 1 Completato', showZero: false },
                    { key: 'lvl2_comp', label: 'Livello 2 Completato', showZero: false },
                    { key: 'conversions', label: 'Conversioni Completate', showZero: false },
                    { key: 'errors', label: 'Errori Totali', showZero: true },
                    { key: 'lvl1_retry', label: 'Reset Livello 1', showZero: true },
                    { key: 'lvl2_retry', label: 'Reset Livello 2', showZero: true }
                ],
                
                onTimerUpdate: (time) => {
                    // Opzionale: mostra timer da qualche parte
                },
                
                onFieldUpdate: (key, value) => {
                    console.log(`Campo ${key} aggiornato: ${value}`);
                }
            });
            
            // Render pannello completo
            certSystem.renderFullPanel('certificateContainer', {
                collapsible: true,
                showStudentControls: true,
                showClassroomToggle: true,
                showVerificationToggle: false
            });
        }
        //#endregion

        // Inizializzazione
        initCertSystem();
        initLevel1();
    </script>
</body>
</html>
